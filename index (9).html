<!DOCTYPE html><html lang="fr" class="h-full dark"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EchoCard Pro - Générateur de Rapport d'Échographie</title>
    <meta name="description" content="Application pour générer des rapports d'échographie cardiaque structurés">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Custom styles */
        .measurement-table td, .measurement-table th {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        .measurement-table input {
            width: 70px;
        }
        /* Normal range styling */
        .normal-range {
            font-size: 0.75rem;
            color: #718096;
        }
        
        /* Dark mode support */
        .dark {
            color-scheme: dark;
        }
        .dark body {
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .dark .bg-white {
            background-color: #2d3748 !important;
        }
        .dark .bg-gray-100 {
            background-color: #1a202c !important;
        }
        .dark .bg-gray-200 {
            background-color: #2d3748 !important;
        }
        .dark .border-gray-200,
        .dark .border-gray-300 {
            border-color: #4a5568 !important;
        }
        .dark .text-gray-700,
        .dark .text-gray-800,
        .dark .text-gray-900 {
            color: #e2e8f0 !important;
        }
        .dark .shadow {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3), 0 1px 2px 0 rgba(0, 0, 0, 0.2);
        }
        .dark input, 
        .dark select, 
        .dark textarea {
            background-color: #4a5568;
            color: #e2e8f0;
            border-color: #718096;
        }
        .dark .normal-range {
            color: #a0aec0;
        }
        .dark .measurement-table td, 
        .dark .measurement-table th {
            border-color: #4a5568;
        }
        .dark .primary-btn {
            background-color: #5D5CDE;
        }
        .dark .secondary-btn {
            background-color: #4a5568;
        }

        /* Button styling */
        .primary-btn {
            background-color: #5D5CDE;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .primary-btn:hover {
            opacity: 0.9;
        }
        .secondary-btn {
            background-color: #e2e8f0;
            color: #4a5568;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .secondary-btn:hover {
            background-color: #cbd5e0;
        }
        .tab {
            cursor: pointer;
            padding: 0.75rem 1rem;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom: 2px solid #5D5CDE;
            color: #5D5CDE;
            font-weight: 500;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Pulse animation for recording */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }
        .pulse {
            animation: pulse 2s infinite;
            border-radius: 50%;
        }
        
        /* Loading animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Print styles */
        @media print {
            body {
                margin: 0;
                padding: 0;
                font-size: 11pt;
            }
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            .page-break {
                page-break-before: always;
            }
            .report-page {
                padding: 20mm;
                max-width: 210mm;
                min-height: 297mm;
                margin: 0 auto;
            }
        }

        /* Mobile-friendly tab navigation */
        @media (max-width: 768px) {
            nav[aria-label="Tabs"] {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none; /* Firefox */
                -ms-overflow-style: none; /* IE/Edge */
            }

            nav[aria-label="Tabs"]::-webkit-scrollbar {
                display: none; /* Chrome/Safari */
            }

            .tab {
                white-space: nowrap;
                flex: 0 0 auto;
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }

            /* Adjust table displays for mobile */
            .measurement-table {
                display: block;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Make inputs larger on mobile */
            input[type="number"],
            input[type="text"],
            input[type="date"],
            select,
            textarea {
                font-size: 16px !important; /* Prevents iOS zoom */
                padding: 0.75rem !important;
                min-height: 44px; /* Minimum touch target size */
            }

            /* Improve button touch targets */
            button {
                min-height: 44px;
                padding: 0.75rem 1rem;
            }

            /* Stack grid columns on mobile */
            .grid {
                grid-template-columns: 1fr !important;
            }

            /* Adjust spacing for mobile */
            .px-4 {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }

            .py-6 {
                padding-top: 1rem !important;
                padding-bottom: 1rem !important;
            }

            /* Make modals more mobile-friendly */
            .modal-content {
                width: 95% !important;
                margin: 1rem auto;
            }
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            /* Larger touch targets for all interactive elements */
            button, 
            input,
            select,
            textarea,
            .tab {
                min-height: 44px; /* Apple's recommended minimum */
                font-size: 16px !important; /* Prevent iOS zoom on focus */
            }

            /* Scrollable tabs with momentum scrolling */
            nav[aria-label="Tabs"] {
                -webkit-overflow-scrolling: touch;
                overflow-x: auto;
                scrollbar-width: none; /* Firefox */
                -ms-overflow-style: none; /* IE/Edge */
                padding: 0.5rem 0;
                margin: 0 -1rem;
                padding-left: 1rem;
            }

            nav[aria-label="Tabs"]::-webkit-scrollbar {
                display: none; /* Chrome/Safari */
            }

            /* Full-width form elements */
            .measurement-table input {
                width: 100%;
                max-width: 120px;
            }

            /* Stack grid columns on mobile */
            .grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }

            /* Increase spacing for touch targets */
            .mb-4 {
                margin-bottom: 1.5rem !important;
            }

            /* Make buttons more prominent */
            .primary-btn,
            .secondary-btn {
                width: 100%;
                margin-bottom: 0.5rem;
                justify-content: center;
                padding: 0.75rem 1rem;
            }

            /* Bottom navigation for mobile */
            .mobile-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--bg-color, white);
                border-top: 1px solid var(--border-color, #e2e8f0);
                padding: 0.5rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                z-index: 50;
                box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            }

            /* Add padding to main content to account for bottom nav */
            main {
                padding-bottom: 80px !important;
            }

            /* Floating action button for quick actions */
            .fab {
                position: fixed;
                bottom: 80px;
                right: 20px;
                width: 56px;
                height: 56px;
                border-radius: 50%;
                background: var(--primary-color, #5D5CDE);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                z-index: 40;
            }

            /* Optimize modals for mobile */
            .modal-content {
                width: 100% !important;
                margin: 0;
                border-radius: 1rem 1rem 0 0;
                position: fixed;
                bottom: 0;
                max-height: 90vh;
                overflow-y: auto;
            }

            /* Improve table scrolling on mobile */
            .measurement-table {
                display: block;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* Dark mode mobile adjustments */
        .dark .mobile-nav {
            --bg-color: #2d3748;
            --border-color: #4a5568;
        }

        .dark .fab {
            --primary-color: #6B7ED9;
        }
    </style>
</head>
<body class="font-sans h-full bg-gray-100">
    <div class="min-h-full">
        <!-- Header -->
        <header class="bg-white shadow border-b border-gray-200 no-print">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900 flex items-center">
                        <span class="text-blue-600 mr-2"><i class="fas fa-heartbeat"></i></span> 
                        EchoCard Pro
                    </h1>
                </div>
                <div class="flex space-x-4">
                    <button id="darkModeToggle" class="p-2 text-gray-600 hover:text-gray-900 rounded">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button id="settingsBtn" class="p-2 text-gray-600 hover:text-gray-900 rounded">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 no-print">
            <!-- Tabs -->
            <div class="border-b border-gray-200 mb-6">
                <nav class="flex space-x-8 overflow-x-auto" aria-label="Tabs">
                    <div class="tab active" data-tab="patient-info">
                        <i class="fas fa-user-circle mr-2"></i> Patient
                    </div>
                    <div class="tab" data-tab="measurements">
                        <i class="fas fa-ruler mr-2"></i> Mesures
                    </div>
                    <div class="tab" data-tab="valvulopathy">
                        <i class="fas fa-heart-broken mr-2"></i> Valvulopathies
                    </div>
                    <div class="tab" data-tab="cardiomyopathy">
                        <i class="fas fa-heart mr-2"></i> Cardiomyopathies
                    </div>
                    <div class="tab" data-tab="congenital">
                        <i class="fas fa-baby mr-2"></i> Cardiopathies Congénitales
                    </div>
                    <div class="tab" data-tab="dictation">
                        <i class="fas fa-microphone mr-2"></i> Dictée
                    </div>
                    <div class="tab" data-tab="report">
                        <i class="fas fa-file-medical-alt mr-2"></i> Rapport
                    </div>
                </nav>
            </div>

            <!-- Flash message container -->
            <div id="flash-message" class="hidden mb-6 p-4 rounded"></div>

            <!-- Patient Information Tab -->
            <div id="patient-info" class="tab-content active">
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-lg font-medium text-gray-900 mb-4">Informations du Patient et de l'Examen</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="patient-name" class="block text-sm font-medium text-gray-700">Nom et prénom du patient</label>
                            <input type="text" id="patient-name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Nom et prénom">
                        </div>
                        <div>
                            <label for="patient-age" class="block text-sm font-medium text-gray-700">Âge</label>
                            <input type="number" id="patient-age" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Âge">
                        </div>
                        <div>
                            <label for="patient-sex" class="block text-sm font-medium text-gray-700">Sexe</label>
                            <select id="patient-sex" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Sélectionner</option>
                                <option value="M">Homme</option>
                                <option value="F">Femme</option>
                            </select>
                        </div>
                        <div>
                            <label for="patient-weight" class="block text-sm font-medium text-gray-700">Poids (kg)</label>
                            <input type="number" id="patient-weight" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Poids">
                        </div>
                        <div>
                            <label for="patient-height" class="block text-sm font-medium text-gray-700">Taille (cm)</label>
                            <input type="number" id="patient-height" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Taille">
                        </div>
                        <div>
                            <label for="sc" class="block text-sm font-medium text-gray-700">Surface Corporelle (m²)</label>
                            <input type="number" id="sc" readonly="" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base bg-gray-50 focus:outline-none" placeholder="Calculée automatiquement">
                        </div>
                        <div>
                            <label for="referring-doctor" class="block text-sm font-medium text-gray-700">Médecin référent</label>
                            <input type="text" id="referring-doctor" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Dr. Nom du médecin">
                        </div>
                        <div>
                            <label for="exam-date" class="block text-sm font-medium text-gray-700">Date de l'examen</label>
                            <input type="date" id="exam-date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label for="clinical-indication" class="block text-sm font-medium text-gray-700">Motif de l'examen</label>
                            <input type="text" id="clinical-indication" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Indication clinique">
                        </div>
                        <div class="md:col-span-2">
                            <label for="echo-quality" class="block text-sm font-medium text-gray-700">Qualité et Echogénécité</label>
                            <select id="echo-quality" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="Excellente">Excellente</option>
                                <option value="Bonne">Bonne</option>
                                <option value="Acceptable">Acceptable</option>
                                <option value="Limitée">Limitée</option>
                                <option value="Mauvaise">Mauvaise</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6">
                        <button id="next-to-measurements" class="primary-btn float-right">
                            Suivant <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Measurements Tab -->
            <div id="measurements" class="tab-content">
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-lg font-medium text-gray-900 mb-4">Mesures Échographiques</h2>
                    
                    <div class="mb-6">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Ventricule Gauche (VG)</h3>
                        <div class="overflow-x-auto">
                            <table class="measurement-table w-full">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th>Mesure</th>
                                        <th>Résultat</th>
                                        <th>Valeur normale</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>DTD (mm)</td>
                                        <td><input type="number" id="vg-dtd" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">37-55mm</td>
                                    </tr>
                                    <tr>
                                        <td>DTS (mm)</td>
                                        <td><input type="number" id="vg-dts" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">22-40mm</td>
                                    </tr>
                                    <tr>
                                        <td>DTD indexé (mm/m²)</td>
                                        <td><input type="number" id="vg-dtd-indexe" step="0.01" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">22-31mm/m²</td>
                                    </tr>
                                    <tr>
                                        <td>Volume TD (ml)</td>
                                        <td><input type="number" id="vg-vtd" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">M: 62-150ml, F: 46-106ml</td>
                                    </tr>
                                    <tr>
                                        <td>Volume TS (ml)</td>
                                        <td><input type="number" id="vg-vts" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">M: 21-61ml, F: 14-42ml</td>
                                    </tr>
                                    <tr>
                                        <td>VTD indexé (ml/m²)</td>
                                        <td><input type="number" id="vg-vtd-indexe" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">M: ≤74ml/m², F: ≤61ml/m²</td>
                                    </tr>
                                    <tr>
                                        <td>FR (%)</td>
                                        <td><input type="number" id="vg-fr" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">24-46%</td>
                                    </tr>
                                    <tr>
                                        <td>FE (%)</td>
                                        <td><input type="number" id="vg-fe" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">53-77%</td>
                                    </tr>
                                    <tr>
                                        <td>FE (Simpson) (%)</td>
                                        <td><input type="number" id="vg-fe-simpson" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">53-77%</td>
                                    </tr>
                                    <tr>
                                        <td>SIV (mm)</td>
                                        <td><input type="number" id="vg-siv" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">7-11mm</td>
                                    </tr>
                                    <tr>
                                        <td>PP (mm)</td>
                                        <td><input type="number" id="vg-pp" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">7-11mm</td>
                                    </tr>
                                    <tr>
                                        <td>SIV/PP</td>
                                        <td><input type="number" id="vg-sivpp" step="0.01" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 1.3</td>
                                    </tr>
                                    <tr>
                                        <td>Masse VG (g)</td>
                                        <td><input type="number" id="vg-masse" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">M: 88-224g, F: 67-162g</td>
                                    </tr>
                                    <tr>
                                        <td>Masse VG indexée (g/m²)</td>
                                        <td><input type="number" id="vg-masse-indexee" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">M: ≤115g/m², F: ≤95g/m²</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Trouble de la Cinétique Ventriculaire Gauche</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Type de Trouble</label>
                                <select id="cinetique-type" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Aucun">Aucun trouble</option>
                                    <option value="Hypokinésie">Hypokinésie</option>
                                    <option value="Akinésie">Akinésie</option>
                                    <option value="Dyskinésie">Dyskinésie</option>
                                    <option value="Asynchronisme">Asynchronisme</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Étendue</label>
                                <select id="cinetique-etendue" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Sélectionnez</option>
                                    <option value="Localisée">Localisée</option>
                                    <option value="Diffuse">Diffuse</option>
                                    <option value="Globale">Globale</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-4">
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="cinetique-anteroseptale" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Antéroseptale</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="cinetique-anterieure" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Antérieure</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="cinetique-laterale" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Latérale</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="cinetique-posterieure" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Postérieure</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="cinetique-inferieure" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Inférieure</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="cinetique-septale" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Septale</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="cinetique-apicale" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Apicale</span>
                                </label>
                            </div>
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" id="cinetique-basale" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-gray-700">Basale</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Oreillette Gauche (OG)</h3>
                        <div class="overflow-x-auto">
                            <table class="measurement-table w-full">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th>Mesure</th>
                                        <th>Résultat</th>
                                        <th>Valeur normale</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Diamètre antéro-postérieur (mm)</td>
                                        <td><input type="number" id="og-ap" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">27-40mm</td>
                                    </tr>
                                    <tr>
                                        <td>Diamètre supéro-inférieur (mm)</td>
                                        <td><input type="number" id="og-si" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">30-55mm</td>
                                    </tr>
                                    <tr>
                                        <td>Diamètre médio-latéral (mm)</td>
                                        <td><input type="number" id="og-ml" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">30-45mm</td>
                                    </tr>
                                    <tr>
                                        <td>Transversal (DOG) (mm)</td>
                                        <td><input type="number" id="og-transversal" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">19-40mm</td>
                                    </tr>
                                    <tr>
                                        <td>Surface OG (cm²)</td>
                                        <td><input type="number" id="og-surface" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">13-17cm²</td>
                                    </tr>
                                    <tr>
                                        <td>Volume OG (ml)</td>
                                        <td><input type="number" id="og-volume" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">M: 18-58ml, F: 22-52ml</td>
                                    </tr>
                                    <tr>
                                        <td>Volume OG indexé (ml/m²)</td>
                                        <td><input type="number" id="og-volume-indexe" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤34ml/m²</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Oreillette Droite (OD)</h3>
                        <div class="overflow-x-auto">
                            <table class="measurement-table w-full">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th>Mesure</th>
                                        <th>Résultat</th>
                                        <th>Valeur normale</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Surface OD (cm²)</td>
                                        <td><input type="number" id="od-surface" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">11-18cm²</td>
                                    </tr>
                                    <tr>
                                        <td>Volume OD (ml)</td>
                                        <td><input type="number" id="od-volume" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">M: 25-61ml, F: 18-46ml</td>
                                    </tr>
                                    <tr>
                                        <td>Volume OD indexé (ml/m²)</td>
                                        <td><input type="number" id="od-volume-indexe" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤28ml/m²</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Ventricule Droit (VD)</h3>
                        <div class="overflow-x-auto">
                            <table class="measurement-table w-full">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th>Mesure</th>
                                        <th>Résultat</th>
                                        <th>Valeur normale</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>DTD (mm)</td>
                                        <td><input type="number" id="vd-dtd" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">10-26mm</td>
                                    </tr>
                                    <tr>
                                        <td>Diamètre basal (mm)</td>
                                        <td><input type="number" id="vd-basal" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">25-41mm</td>
                                    </tr>
                                    <tr>
                                        <td>Diamètre médian (mm)</td>
                                        <td><input type="number" id="vd-median" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">19-35mm</td>
                                    </tr>
                                    <tr>
                                        <td>Longueur (mm)</td>
                                        <td><input type="number" id="vd-longueur" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">59-83mm</td>
                                    </tr>
                                    <tr>
                                        <td>TAPSE (mm)</td>
                                        <td><input type="number" id="vd-tapse" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≥ 17mm</td>
                                    </tr>
                                    <tr>
                                        <td>Onde S' (cm/s)</td>
                                        <td><input type="number" id="vd-onde-s" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≥ 9.5cm/s</td>
                                    </tr>
                                    <tr>
                                        <td>FAC (%)</td>
                                        <td><input type="number" id="vd-fac" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≥ 35%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Aorte</h3>
                        <div class="overflow-x-auto">
                            <table class="measurement-table w-full">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th>Mesure</th>
                                        <th>Résultat</th>
                                        <th>Valeur normale</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Anneau (mm)</td>
                                        <td><input type="number" id="aorte-anneau" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">18-25mm</td>
                                    </tr>
                                    <tr>
                                        <td>Sinus de Valsalva (mm)</td>
                                        <td><input type="number" id="aorte-sinus" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">20-37mm</td>
                                    </tr>
                                    <tr>
                                        <td>Jonction sino-tubulaire (mm)</td>
                                        <td><input type="number" id="aorte-jonction" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">20-36mm</td>
                                    </tr>
                                    <tr>
                                        <td>Racine (mm)</td>
                                        <td><input type="number" id="aorte-racine" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">20-37mm</td>
                                    </tr>
                                    <tr>
                                        <td>Ascendante (mm)</td>
                                        <td><input type="number" id="aorte-ascendante" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">20-37mm</td>
                                    </tr>
                                    <tr>
                                        <td>Crosse (mm)</td>
                                        <td><input type="number" id="aorte-crosse" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">20-30mm</td>
                                    </tr>
                                    <tr>
                                        <td>Descendante (mm)</td>
                                        <td><input type="number" id="aorte-descendante" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">20-30mm</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Doppler</h3>
                        <div class="overflow-x-auto">
                            <table class="measurement-table w-full">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th>Mesure</th>
                                        <th>Résultat</th>
                                        <th>Valeur normale</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Onde E (m/s)</td>
                                        <td><input type="number" id="doppler-onde-e" step="0.01" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">0.6-1.3</td>
                                    </tr>
                                    <tr>
                                        <td>Onde A (m/s)</td>
                                        <td><input type="number" id="doppler-onde-a" step="0.01" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">0.2-0.9</td>
                                    </tr>
                                    <tr>
                                        <td>Rapport E/A</td>
                                        <td><input type="number" id="doppler-ea" step="0.01" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">0.7-3.0</td>
                                    </tr>
                                    <tr>
                                        <td>Temps de décélération E (ms)</td>
                                        <td><input type="number" id="doppler-tde" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">140-220ms</td>
                                    </tr>
                                    <tr>
                                        <td>E' latéral (cm/s)</td>
                                        <td><input type="number" id="doppler-eprime-lat" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≥ 10cm/s</td>
                                    </tr>
                                    <tr>
                                        <td>E' septal (cm/s)</td>
                                        <td><input type="number" id="doppler-eprime-sep" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≥ 7cm/s</td>
                                    </tr>
                                    <tr>
                                        <td>E' moyen (cm/s)</td>
                                        <td><input type="number" id="doppler-eprime" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≥ 8cm/s</td>
                                    </tr>
                                    <tr>
                                        <td>E/E'</td>
                                        <td><input type="number" id="doppler-eeprime" step="0.01" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 14</td>
                                    </tr>
                                    <tr>
                                        <td>A' (cm/s)</td>
                                        <td><input type="number" id="doppler-aprime" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≥ 7cm/s</td>
                                    </tr>
                                    <tr>
                                        <td>TRIV (ms)</td>
                                        <td><input type="number" id="doppler-triv" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">50-90ms</td>
                                    </tr>
                                    <tr>
                                        <td>ITV sous Ao (cm)</td>
                                        <td><input type="number" id="doppler-itv" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">18-22cm</td>
                                    </tr>
                                    <tr>
                                        <td>PAPs (mmHg)</td>
                                        <td><input type="number" id="doppler-paps" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 35mmHg</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Veine Cave Inférieure (VCI)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Diamètre (mm)</label>
                                <input type="number" id="vci-diametre" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Compliance respiratoire</label>
                                <select id="vci-compliance" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Normale">Normale (&gt; 50%)</option>
                                    <option value="Réduite">Réduite (&lt; 50%)</option>
                                    <option value="Absente">Absente</option>
                                    <option value="Non évaluable">Non évaluable</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Péricarde</h3>
                        <div class="grid grid-cols-1 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">État du péricarde</label>
                                <select id="pericarde" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Normal">Normal</option>
                                    <option value="Épanchement minime">Épanchement minime</option>
                                    <option value="Épanchement modéré">Épanchement modéré</option>
                                    <option value="Épanchement important">Épanchement important</option>
                                    <option value="Tamponnade">Tamponnade</option>
                                    <option value="Péricardite constrictive">Péricardite constrictive</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-between">
                        <button id="back-to-patient" class="secondary-btn">
                            <i class="fas fa-arrow-left mr-2"></i> Retour
                        </button>
                        <button id="next-to-valvulopathy" class="primary-btn">
                            Suivant <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Valvulopathy Tab -->
            <div id="valvulopathy" class="tab-content">
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-lg font-medium text-gray-900 mb-4">Valvulopathies</h2>
                    
                    <div class="mb-8">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Valve Aortique</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">État de la valve</label>
                                <select id="valve-aortique" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Normale">Normale</option>
                                    <option value="Sclérose">Sclérose sans sténose</option>
                                    <option value="Calcifications">Calcifications</option>
                                    <option value="Bicuspidie">Bicuspidie</option>
                                    <option value="Végétations">Végétations</option>
                                    <option value="Prothèse mécanique">Prothèse mécanique</option>
                                    <option value="Bioprothèse">Bioprothèse</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sténose Aortique</label>
                                <select id="valve-ao-stenose" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Légère">Légère</option>
                                    <option value="Modérée">Modérée</option>
                                    <option value="Sévère">Sévère</option>
                                    <option value="Très sévère">Très sévère</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Insuffisance Aortique</label>
                                <select id="valve-ao-insuffisance" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Minime">Minime</option>
                                    <option value="Légère">Légère</option>
                                    <option value="Modérée">Modérée</option>
                                    <option value="Sévère">Sévère</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="measurement-table w-full">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th>Paramètre</th>
                                        <th>Résultat</th>
                                        <th>Valeur normale/seuil</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Surface valvulaire (cm²)</td>
                                        <td><input type="number" id="ao-surface" step="0.01" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≥ 2.0cm²</td>
                                    </tr>
                                    <tr>
                                        <td>Surface indexée (cm²/m²)</td>
                                        <td><input type="number" id="ao-surface-indexee" step="0.01" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≥ 0.85cm²/m²</td>
                                    </tr>
                                    <tr>
                                        <td>Vmax (m/s)</td>
                                        <td><input type="number" id="ao-vmax" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 2.5m/s</td>
                                    </tr>
                                    <tr>
                                        <td>Gradient moyen (mmHg)</td>
                                        <td><input type="number" id="ao-gradient-moyen" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 20mmHg</td>
                                    </tr>
                                    <tr>
                                        <td>Gradient maximal (mmHg)</td>
                                        <td><input type="number" id="ao-gradient-max" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 30mmHg</td>
                                    </tr>
                                    <tr>
                                        <td>Ratio VTI LVOT/Ao</td>
                                        <td><input type="number" id="ao-ratio-vti" step="0.01" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≥ 0.25</td>
                                    </tr>
                                    <tr>
                                        <td>Orifice régurgitant effectif (mm²)</td>
                                        <td><input type="number" id="ao-ore" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 10mm²</td>
                                    </tr>
                                    <tr>
                                        <td>Volume régurgitant (ml)</td>
                                        <td><input type="number" id="ao-vol-reg" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 30ml</td>
                                    </tr>
                                    <tr>
                                        <td>Largeur du jet/LVOT (%)</td>
                                        <td><input type="number" id="ao-jet-width" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">&lt; 25%</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Valve Mitrale</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">État de la valve</label>
                                <select id="valve-mitrale" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Normale">Normale</option>
                                    <option value="Prolapsus">Prolapsus valvulaire</option>
                                    <option value="Remaniement fibreux">Remaniement fibreux</option>
                                    <option value="Calcifications">Calcifications</option>
                                    <option value="Végétations">Végétations</option>
                                    <option value="Prothèse mécanique">Prothèse mécanique</option>
                                    <option value="Bioprothèse">Bioprothèse</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sténose Mitrale</label>
                                <select id="valve-mit-stenose" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Légère">Légère</option>
                                    <option value="Modérée">Modérée</option>
                                    <option value="Sévère">Sévère</option>
                                    <option value="Très sévère">Très sévère</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Insuffisance Mitrale</label>
                                <select id="valve-mit-insuffisance" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Minime">Minime</option>
                                    <option value="Légère">Légère</option>
                                    <option value="Modérée">Modérée</option>
                                    <option value="Sévère">Sévère</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="measurement-table w-full">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th>Paramètre</th>
                                        <th>Résultat</th>
                                        <th>Valeur normale/seuil</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Surface valvulaire (cm²)</td>
                                        <td><input type="number" id="mit-surface" step="0.01" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≥ 4.0cm²</td>
                                    </tr>
                                    <tr>
                                        <td>Gradient moyen (mmHg)</td>
                                        <td><input type="number" id="mit-gradient-moyen" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 5mmHg</td>
                                    </tr>
                                    <tr>
                                        <td>PHT (ms)</td>
                                        <td><input type="number" id="mit-pht" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 130ms</td>
                                    </tr>
                                    <tr>
                                        <td>Orifice régurgitant effectif (mm²)</td>
                                        <td><input type="number" id="mit-ore" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 20mm²</td>
                                    </tr>
                                    <tr>
                                        <td>Volume régurgitant (ml)</td>
                                        <td><input type="number" id="mit-vol-reg" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 30ml</td>
                                    </tr>
                                    <tr>
                                        <td>Vena contracta (mm)</td>
                                        <td><input type="number" id="mit-vena-contracta" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">&lt; 3mm</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Valve Tricuspide</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">État de la valve</label>
                                <select id="valve-tricuspide" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Normale">Normale</option>
                                    <option value="Remaniement">Remaniement</option>
                                    <option value="Prolapsus">Prolapsus</option>
                                    <option value="Végétations">Végétations</option>
                                    <option value="Prothèse">Prothèse</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sténose Tricuspidienne</label>
                                <select id="valve-tri-stenose" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Légère">Légère</option>
                                    <option value="Modérée">Modérée</option>
                                    <option value="Sévère">Sévère</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Insuffisance Tricuspidienne</label>
                                <select id="valve-tri-insuffisance" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Minime">Minime</option>
                                    <option value="Légère">Légère</option>
                                    <option value="Modérée">Modérée</option>
                                    <option value="Sévère">Sévère</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="measurement-table w-full">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th>Paramètre</th>
                                        <th>Résultat</th>
                                        <th>Valeur normale/seuil</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Gradient moyen (mmHg)</td>
                                        <td><input type="number" id="tri-gradient-moyen" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 2mmHg</td>
                                    </tr>
                                    <tr>
                                        <td>Vena contracta (mm)</td>
                                        <td><input type="number" id="tri-vena-contracta" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">&lt; 7mm</td>
                                    </tr>
                                    <tr>
                                        <td>PISA radius (mm)</td>
                                        <td><input type="number" id="tri-pisa" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">&lt; 5mm</td>
                                    </tr>
                                    <tr>
                                        <td>Orifice régurgitant effectif (mm²)</td>
                                        <td><input type="number" id="tri-ore" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 40mm²</td>
                                    </tr>
                                    <tr>
                                        <td>Vitesse IT max (m/s)</td>
                                        <td><input type="number" id="tri-it-vmax" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 2.8m/s</td>
                                    </tr>
                                    <tr>
                                        <td>Gradient IT max (mmHg)</td>
                                        <td><input type="number" id="tri-it-gmax" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 30mmHg</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Valve Pulmonaire</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">État de la valve</label>
                                <select id="valve-pulmonaire" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Normale">Normale</option>
                                    <option value="Remaniement">Remaniement</option>
                                    <option value="Sténosée">Sténosée</option>
                                    <option value="Prothèse">Prothèse</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sténose Pulmonaire</label>
                                <select id="valve-pul-stenose" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Légère">Légère</option>
                                    <option value="Modérée">Modérée</option>
                                    <option value="Sévère">Sévère</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Insuffisance Pulmonaire</label>
                                <select id="valve-pul-insuffisance" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Minime">Minime</option>
                                    <option value="Légère">Légère</option>
                                    <option value="Modérée">Modérée</option>
                                    <option value="Sévère">Sévère</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="measurement-table w-full">
                                <thead>
                                    <tr class="bg-gray-100">
                                        <th>Paramètre</th>
                                        <th>Résultat</th>
                                        <th>Valeur normale/seuil</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Vmax (m/s)</td>
                                        <td><input type="number" id="pul-vmax" step="0.1" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 2.2m/s</td>
                                    </tr>
                                    <tr>
                                        <td>Gradient moyen (mmHg)</td>
                                        <td><input type="number" id="pul-gradient-moyen" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 10mmHg</td>
                                    </tr>
                                    <tr>
                                        <td>Gradient maximal (mmHg)</td>
                                        <td><input type="number" id="pul-gradient-max" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≤ 20mmHg</td>
                                    </tr>
                                    <tr>
                                        <td>Temps de demi-décroissance IP (ms)</td>
                                        <td><input type="number" id="pul-ip-phd" class="border border-gray-300 rounded"></td>
                                        <td class="normal-range">≥ 100ms</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="valvulopathy-diagnostic" class="p-4 mt-6 mb-6 bg-blue-50 border border-blue-200 rounded-lg">
                        <h3 class="text-md font-medium text-blue-800 mb-2">Diagnostic Valvulaire Suggéré</h3>
                        <div id="valvular-diagnostic-content" class="text-blue-800">
                            Remplissez les mesures valvulaires pour obtenir un diagnostic suggéré.
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-between">
                        <button id="back-to-measurements" class="secondary-btn">
                            <i class="fas fa-arrow-left mr-2"></i> Retour
                        </button>
                        <button id="update-valvular-diagnostic" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md mx-2">
                            <i class="fas fa-sync-alt mr-2"></i> Mettre à jour le diagnostic
                        </button>
                        <button id="next-to-cardiomyopathy" class="primary-btn">
                            Suivant <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Cardiomyopathy Tab -->
            <div id="cardiomyopathy" class="tab-content">
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-lg font-medium text-gray-900 mb-4">Cardiomyopathies</h2>
                    
                    <div class="mb-6">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Classification principale</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Type de cardiomyopathie</label>
                                <select id="cardio-type" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Aucune">Aucune cardiomyopathie</option>
                                    <option value="Dilatée">Cardiomyopathie dilatée</option>
                                    <option value="Hypertrophique">Cardiomyopathie hypertrophique</option>
                                    <option value="Restrictive">Cardiomyopathie restrictive</option>
                                    <option value="Arythmogène du VD">Cardiomyopathie arythmogène du VD</option>
                                    <option value="Non compaction">Cardiomyopathie par non-compaction</option>
                                    <option value="Takotsubo">Cardiomyopathie de Takotsubo</option>
                                    <option value="Autre">Autre</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sévérité</label>
                                <select id="cardio-severite" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Non applicable</option>
                                    <option value="Légère">Légère</option>
                                    <option value="Modérée">Modérée</option>
                                    <option value="Sévère">Sévère</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cardiomyopathie dilatée -->
                    <div id="cmd-section" class="mb-6 hidden">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Cardiomyopathie Dilatée - Critères additionnels</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dilatation VG</label>
                                <select id="cmd-dilatation" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Légère">Légère</option>
                                    <option value="Modérée">Modérée</option>
                                    <option value="Sévère">Sévère</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dysfonction systolique VG</label>
                                <select id="cmd-systolique" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Légère">Légère (FEVG 45-54%)</option>
                                    <option value="Modérée">Modérée (FEVG 30-44%)</option>
                                    <option value="Sévère">Sévère (FEVG &lt; 30%)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fonction VD</label>
                                <select id="cmd-vd" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Normale">Normale</option>
                                    <option value="Altérée">Altérée</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Origine suspectée</label>
                                <select id="cmd-origine" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Indéterminée">Indéterminée</option>
                                    <option value="Idiopathique">Idiopathique</option>
                                    <option value="Ischémique">Ischémique</option>
                                    <option value="Valvulaire">Valvulaire</option>
                                    <option value="Toxique">Toxique/Médicamenteuse</option>
                                    <option value="Génétique">Génétique/Familiale</option>
                                    <option value="Inflammatoire">Inflammatoire/Infectieuse</option>
                                    <option value="Tachycardiomyopathie">Tachycardiomyopathie</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cardiomyopathie hypertrophique -->
                    <div id="cmh-section" class="mb-6 hidden">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Cardiomyopathie Hypertrophique - Critères additionnels</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Type d'hypertrophie</label>
                                <select id="cmh-type" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Septale asymétrique">Septale asymétrique</option>
                                    <option value="Concentrique">Concentrique</option>
                                    <option value="Apicale">Apicale</option>
                                    <option value="Médio-ventriculaire">Médio-ventriculaire</option>
                                    <option value="Latérale">Latérale</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Épaisseur maximale (mm)</label>
                                <input type="number" id="cmh-epaisseur" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Obstruction sous-aortique</label>
                                <select id="cmh-obstruction" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente (&lt; 30 mmHg)</option>
                                    <option value="Au repos">Présente au repos (≥ 30 mmHg)</option>
                                    <option value="Provoquée">Provoquée (≥ 30 mmHg)</option>
                                    <option value="Sévère">Sévère (≥ 50 mmHg)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Gradient maximal (mmHg)</label>
                                <input type="number" id="cmh-gradient" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">SAM (Mouvement systolique antérieur)</label>
                                <select id="cmh-sam" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absent">Absent</option>
                                    <option value="Présent sans contact">Présent sans contact septal</option>
                                    <option value="Présent avec contact">Présent avec contact septal</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Insuffisance mitrale associée</label>
                                <select id="cmh-im" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Légère">Légère</option>
                                    <option value="Modérée">Modérée</option>
                                    <option value="Sévère">Sévère</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cardiomyopathie restrictive -->
                    <div id="cmr-section" class="mb-6 hidden">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Cardiomyopathie Restrictive - Critères additionnels</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Profil de remplissage</label>
                                <select id="cmr-remplissage" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Normal">Normal</option>
                                    <option value="Trouble relaxation">Trouble de la relaxation</option>
                                    <option value="Pseudo-normal">Pseudo-normal</option>
                                    <option value="Restrictif">Restrictif</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dilatation bi-auriculaire</label>
                                <select id="cmr-dilatation" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Légère">Légère</option>
                                    <option value="Modérée">Modérée</option>
                                    <option value="Sévère">Sévère</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Épaississement des parois</label>
                                <select id="cmr-parois" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absent">Absent</option>
                                    <option value="Présent">Présent</option>
                                    <option value="Granuleux">Aspect granuleux/scintillant</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Étiologie suspectée</label>
                                <select id="cmr-etiologie" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Indéterminée">Indéterminée</option>
                                    <option value="Amylose">Amylose</option>
                                    <option value="Sarcoïdose">Sarcoïdose</option>
                                    <option value="Hémochromatose">Hémochromatose</option>
                                    <option value="Fibrose endomyocardique">Fibrose endomyocardique</option>
                                    <option value="Post-radiothérapie">Post-radiothérapie</option>
                                    <option value="Médicamenteuse">Médicamenteuse</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cardiomyopathie arythmogène du VD -->
                    <div id="cmavd-section" class="mb-6 hidden">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Cardiomyopathie Arythmogène du VD - Critères additionnels</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dilatation VD</label>
                                <select id="cmavd-dilatation" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Légère">Légère</option>
                                    <option value="Modérée">Modérée</option>
                                    <option value="Sévère">Sévère</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Anévrisme VD</label>
                                <select id="cmavd-anevrisme" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absent">Absent</option>
                                    <option value="Présent">Présent</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Dysfonction VD</label>
                                <select id="cmavd-dysfonction" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Légère">Légère</option>
                                    <option value="Modérée">Modérée</option>
                                    <option value="Sévère">Sévère</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Atteinte VG associée</label>
                                <select id="cmavd-vg" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Présente">Présente</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Non compaction -->
                    <div id="cmnc-section" class="mb-6 hidden">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Cardiomyopathie par Non-Compaction - Critères additionnels</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ratio NC/C maximal</label>
                                <input type="number" id="cmnc-ratio" step="0.1" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Localisation principale</label>
                                <select id="cmnc-localisation" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Apex">Apex</option>
                                    <option value="Paroi latérale">Paroi latérale</option>
                                    <option value="Paroi inférieure">Paroi inférieure</option>
                                    <option value="Septum">Septum</option>
                                    <option value="Multiple">Multiple</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fonction systolique VG</label>
                                <select id="cmnc-fonction" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Normale">Normale</option>
                                    <option value="Légèrement altérée">Légèrement altérée</option>
                                    <option value="Modérément altérée">Modérément altérée</option>
                                    <option value="Sévèrement altérée">Sévèrement altérée</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Thrombus intra-cavitaire</label>
                                <select id="cmnc-thrombus" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absent">Absent</option>
                                    <option value="Présent">Présent</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Takotsubo -->
                    <div id="cmtako-section" class="mb-6 hidden">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Cardiomyopathie de Takotsubo - Critères additionnels</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Type morphologique</label>
                                <select id="cmtako-type" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Apical classique">Apical classique (typique)</option>
                                    <option value="Médio-ventriculaire">Médio-ventriculaire</option>
                                    <option value="Basal">Basal (inversé)</option>
                                    <option value="Focal">Focal</option>
                                    <option value="Biventricular">Biventricular</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">FEVG (%)</label>
                                <input type="number" id="cmtako-fevg" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Obstruction intraventriculaire</label>
                                <select id="cmtako-obstruction" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Présente">Présente</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Insuffisance mitrale associée</label>
                                <select id="cmtako-im" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Légère">Légère</option>
                                    <option value="Modérée">Modérée</option>
                                    <option value="Sévère">Sévère</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="cardiomyopathy-diagnostic" class="p-4 mt-6 mb-6 bg-green-50 border border-green-200 rounded-lg">
                        <h3 class="text-md font-medium text-green-800 mb-2">Diagnostic Suggéré</h3>
                        <div id="cardiomyopathy-diagnostic-content" class="text-green-800">
                            Remplissez les critères pour obtenir un diagnostic suggéré.
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-between">
                        <button id="back-to-valvulopathy" class="secondary-btn">
                            <i class="fas fa-arrow-left mr-2"></i> Retour
                        </button>
                        <button id="update-cardiomyopathy-diagnostic" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md mx-2">
                            <i class="fas fa-sync-alt mr-2"></i> Mettre à jour le diagnostic
                        </button>
                        <button id="next-to-congenital" class="primary-btn">
                            Suivant <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Congenital Heart Disease Tab -->
            <div id="congenital" class="tab-content">
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-lg font-medium text-gray-900 mb-4">Cardiopathies Congénitales</h2>
                    
                    <div class="mb-6">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Shunts</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Communication Interauriculaire (CIA)</label>
                                <select id="cc-cia" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Ostium secundum">Ostium secundum</option>
                                    <option value="Ostium primum">Ostium primum</option>
                                    <option value="Sinus venosus">Sinus venosus</option>
                                    <option value="Multiple">Multiple</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Taille de la CIA (mm)</label>
                                <input type="number" id="cc-cia-taille" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Communication Interventriculaire (CIV)</label>
                                <select id="cc-civ" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Périmembraneuse">Périmembraneuse</option>
                                    <option value="Musculaire">Musculaire</option>
                                    <option value="Sous-aortique">Sous-aortique</option>
                                    <option value="Sous-pulmonaire">Sous-pulmonaire</option>
                                    <option value="Multiple">Multiple</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Taille de la CIV (mm)</label>
                                <input type="number" id="cc-civ-taille" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Gradient à travers la CIV (mmHg)</label>
                                <input type="number" id="cc-civ-gradient" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Direction du shunt</label>
                                <select id="cc-shunt-direction" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Aucun">Aucun</option>
                                    <option value="Gauche-droite">Gauche-droite</option>
                                    <option value="Droite-gauche">Droite-gauche</option>
                                    <option value="Bidirectionnel">Bidirectionnel</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Canal Artériel Persistant (PCA)</label>
                                <select id="cc-pca" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absent">Absent</option>
                                    <option value="Présent">Présent</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Diamètre du PCA (mm)</label>
                                <input type="number" id="cc-pca-taille" step="0.1" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Anomalies valvulaires congénitales</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bicuspidie aortique</label>
                                <select id="cc-bicuspidie" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Type 0">Type 0 (aucun raphé)</option>
                                    <option value="Type 1">Type 1 (1 raphé)</option>
                                    <option value="Type 2">Type 2 (2 raphés)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fusion commissurale</label>
                                <select id="cc-fusion" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Aucune">Aucune</option>
                                    <option value="Droite-gauche">Droite-gauche</option>
                                    <option value="Droite-non coronaire">Droite-non coronaire</option>
                                    <option value="Gauche-non coronaire">Gauche-non coronaire</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sténose pulmonaire congénitale</label>
                                <select id="cc-stenose-pulm" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Valvulaire">Valvulaire</option>
                                    <option value="Sous-valvulaire">Sous-valvulaire</option>
                                    <option value="Supra-valvulaire">Supra-valvulaire</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Gradient maximal (mmHg)</label>
                                <input type="number" id="cc-gradient-pulm" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-md font-medium text-gray-800 mb-3">Cardiopathies complexes</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Anomalie d'Ebstein</label>
                                <select id="cc-ebstein" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Légère">Légère</option>
                                    <option value="Modérée">Modérée</option>
                                    <option value="Sévère">Sévère</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Décalage septal (mm)</label>
                                <input type="number" id="cc-ebstein-deplacement" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tétralogie de Fallot</label>
                                <select id="cc-fallot" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="Présente">Présente</option>
                                    <option value="Réparée">Réparée</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Transposition des gros vaisseaux</label>
                                <select id="cc-tgv" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="Absente">Absente</option>
                                    <option value="TGV simple">TGV simple</option>
                                    <option value="TGV complexe">TGV complexe</option>
                                    <option value="TGV corrigée">TGV congénitalement corrigée</option>
                                    <option value="Réparée">Réparée</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Autre anomalie congénitale</label>
                                <input type="text" id="cc-autre" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Préciser...">
                            </div>
                        </div>
                    </div>
                    
                    <div id="congenital-diagnostic" class="p-4 mt-6 mb-6 bg-indigo-50 border border-indigo-200 rounded-lg">
                        <h3 class="text-md font-medium text-indigo-800 mb-2">Diagnostic Suggéré</h3>
                        <div id="congenital-diagnostic-content" class="text-indigo-800">
                            Remplissez les critères pour obtenir un diagnostic suggéré.
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-between">
                        <button id="back-to-cardiomyopathy" class="secondary-btn">
                            <i class="fas fa-arrow-left mr-2"></i> Retour
                        </button>
                        <button id="update-congenital-diagnostic" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-md mx-2">
                            <i class="fas fa-sync-alt mr-2"></i> Mettre à jour le diagnostic
                        </button>
                        <button id="next-to-dictation" class="primary-btn">
                            Suivant <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dictation Tab -->
            <div id="dictation" class="tab-content">
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-lg font-medium text-gray-900 mb-4">Dictée Vocale du Rapport</h2>
                    
                    <div class="mb-6">
                        <div class="flex items-center mb-4">
                            <button id="start-recording" class="primary-btn flex items-center">
                                <i class="fas fa-microphone mr-2"></i> Commencer la dictée
                            </button>
                            <button id="stop-recording" class="secondary-btn ml-4 hidden">
                                <i class="fas fa-stop-circle mr-2"></i> Arrêter la dictée
                            </button>
                            <button id="generate-conclusion" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md ml-4">
                                <i class="fas fa-magic mr-2"></i> Générer conclusion
                            </button>
                            <div id="recording-indicator" class="hidden ml-4">
                                <div class="w-3 h-3 bg-red-500 rounded-full pulse"></div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Commentaire</label>
                            <div class="relative">
                                <textarea id="commentaire" rows="6" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Dictez ou tapez votre commentaire ici..."></textarea>
                                <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-xs text-gray-500" id="dictation-status"></div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Doppler</label>
                            <textarea id="doppler-commentaire" rows="3" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Commentaire sur les mesures Doppler..."></textarea>
                        </div>
                        
                        <div class="mt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Conclusion</label>
                            <textarea id="conclusion" rows="3" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Conclusion de l'examen..."></textarea>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-between">
                        <button id="back-to-congenital" class="secondary-btn">
                            <i class="fas fa-arrow-left mr-2"></i> Retour
                        </button>
                        <button id="next-to-report" class="primary-btn">
                            Voir le rapport <i class="fas fa-arrow-right ml-2"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report Tab -->
            <div id="report" class="tab-content">
                <div class="bg-white shadow rounded-lg p-6">
                    <h2 class="text-lg font-medium text-gray-900 mb-4">Rapport d'Échographie Doppler Cardiaque</h2>
                    
                    <div id="report-preview" class="mb-6 border border-gray-200 rounded-lg p-6">
                        <!-- Report content will be rendered here -->
                        <div class="text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Génération du rapport en cours...</p>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <button id="analyze-report" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md flex items-center">
                            <i class="fas fa-brain mr-2"></i> Analyse IA du Rapport
                        </button>
                        <div id="ai-analysis" class="mt-4 p-4 border border-gray-200 rounded-lg hidden">
                            <h3 class="text-md font-medium text-gray-800 mb-2">Analyse IA</h3>
                            <div id="ai-analysis-content" class="text-gray-700">
                                <!-- AI analysis will be shown here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap justify-center space-x-2 space-y-2 sm:space-y-0">
                        <button id="generate-pdf" class="primary-btn flex items-center">
                            <i class="fas fa-file-pdf mr-2"></i> Générer PDF
                        </button>
                        <button id="print-report" class="secondary-btn flex items-center">
                            <i class="fas fa-print mr-2"></i> Imprimer
                        </button>
                        <button id="share-report" class="secondary-btn flex items-center">
                            <i class="fas fa-share-alt mr-2"></i> Partager
                        </button>
                        <button id="save-report" class="secondary-btn flex items-center">
                            <i class="fas fa-save mr-2"></i> Enregistrer
                        </button>
                        <button id="reset-form" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md flex items-center">
                            <i class="fas fa-redo-alt mr-2"></i> Nouveau Rapport
                        </button>
                    </div>
                    
                    <div class="mt-6">
                        <button id="back-to-dictation" class="secondary-btn">
                            <i class="fas fa-arrow-left mr-2"></i> Retour
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Add this just before closing main tag -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-2 md:hidden z-50">
            <div class="flex justify-between items-center">
                <button id="prev-tab" class="text-gray-600 p-2">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <span id="current-tab-name" class="text-sm font-medium">Patient</span>
                <button id="next-tab" class="text-gray-600 p-2">
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <!-- Print-only report -->
        <div id="print-report-content" class="hidden print-only">
            <div class="report-page">
                <!-- Report content for printing will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden no-print">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Paramètres</h3>
                    <button id="close-settings" class="text-gray-400 hover:text-gray-500">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nom du Médecin</label>
                    <input type="text" id="doctor-name" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Dr. Nom du médecin">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Organisation / Hôpital</label>
                    <input type="text" id="organization" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="CNC: Centre National de Cardiologie">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Logo (URL)</label>
                    <input type="text" id="logo-url" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="URL du logo">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Modèle de Rapport</label>
                    <select id="report-template" class="block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 text-base focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="compact">Compact (une page)</option>
                        <option value="standard">Standard</option>
                        <option value="detailed">Détaillé</option>
                    </select>
                </div>
                <div class="mt-6 flex justify-end">
                    <button id="save-settings" class="primary-btn">
                        Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode detection and toggle
        function initDarkMode() {
            // Remove automatic dark mode detection
            document.getElementById('darkModeToggle').addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
            });
        }
        
        // Tab navigation
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to current tab and content
                    tab.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Button navigation between tabs
            document.getElementById('next-to-measurements').addEventListener('click', () => {
                switchToTab('measurements');
            });
            
            document.getElementById('back-to-patient').addEventListener('click', () => {
                switchToTab('patient-info');
            });
            
            document.getElementById('next-to-valvulopathy').addEventListener('click', () => {
                switchToTab('valvulopathy');
            });
            
            document.getElementById('back-to-measurements').addEventListener('click', () => {
                switchToTab('measurements');
            });
            
            document.getElementById('next-to-cardiomyopathy').addEventListener('click', () => {
                switchToTab('cardiomyopathy');
            });
            
            document.getElementById('back-to-valvulopathy').addEventListener('click', () => {
                switchToTab('valvulopathy');
            });
            
            document.getElementById('next-to-congenital').addEventListener('click', () => {
                switchToTab('congenital');
            });
            
            document.getElementById('back-to-cardiomyopathy').addEventListener('click', () => {
                switchToTab('cardiomyopathy');
            });
            
            document.getElementById('next-to-dictation').addEventListener('click', () => {
                switchToTab('dictation');
            });
            
            document.getElementById('back-to-congenital').addEventListener('click', () => {
                switchToTab('congenital');
            });
            
            document.getElementById('next-to-report').addEventListener('click', () => {
                generateReport();
                switchToTab('report');
            });
            
            document.getElementById('back-to-dictation').addEventListener('click', () => {
                switchToTab('dictation');
            });

            // Mobile navigation
            const prevTabBtn = document.getElementById('prev-tab');
            const nextTabBtn = document.getElementById('next-tab');
            const currentTabName = document.getElementById('current-tab-name');
            const tabOrder = ['patient-info', 'measurements', 'valvulopathy', 'cardiomyopathy', 'congenital', 'dictation', 'report'];

            function updateMobileNav() {
                const activeTab = document.querySelector('.tab.active');
                const activeTabId = activeTab.getAttribute('data-tab');
                const currentIndex = tabOrder.indexOf(activeTabId);
                
                currentTabName.textContent = activeTab.textContent.trim();
                prevTabBtn.disabled = currentIndex === 0;
                nextTabBtn.disabled = currentIndex === tabOrder.length - 1;
                
                prevTabBtn.style.opacity = prevTabBtn.disabled ? '0.5' : '1';
                nextTabBtn.style.opacity = nextTabBtn.disabled ? '0.5' : '1';
            }

            prevTabBtn.addEventListener('click', () => {
                const activeTab = document.querySelector('.tab.active');
                const activeTabId = activeTab.getAttribute('data-tab');
                const currentIndex = tabOrder.indexOf(activeTabId);
                
                if (currentIndex > 0) {
                    switchToTab(tabOrder[currentIndex - 1]);
                    updateMobileNav();
                }
            });

            nextTabBtn.addEventListener('click', () => {
                const activeTab = document.querySelector('.tab.active');
                const activeTabId = activeTab.getAttribute('data-tab');
                const currentIndex = tabOrder.indexOf(activeTabId);
                
                if (currentIndex < tabOrder.length - 1) {
                    switchToTab(tabOrder[currentIndex + 1]);
                    updateMobileNav();
                }
            });

            // Update mobile nav on tab change
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    updateMobileNav();
                });
            });

            // Initial mobile nav state
            updateMobileNav();
        }
        
        function switchToTab(tabId) {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }
        
        // Surface corporelle calculation
        function initBSACalculation() {
            const weightInput = document.getElementById('patient-weight');
            const heightInput = document.getElementById('patient-height');
            const scOutput = document.getElementById('sc');
            
            function calculateBSA() {
                const weight = parseFloat(weightInput.value);
                const height = parseFloat(heightInput.value);
                
                if (weight && height) {
                    // Dubois formula: BSA (m²) = 0.007184 × weight(kg)^0.425 × height(cm)^0.725
                    const bsa = 0.007184 * Math.pow(weight, 0.425) * Math.pow(height, 0.725);
                    scOutput.value = bsa.toFixed(2);
                } else {
                    scOutput.value = "";
                }
                
                // Auto-calculate indexed values if BSA changed
                calculateIndexedValues(scOutput.value);
            }
            
            weightInput.addEventListener('input', calculateBSA);
            heightInput.addEventListener('input', calculateBSA);
        }
        
        // Calculate indexed values when BSA changes
        function calculateIndexedValues(bsa) {
            if (!bsa || isNaN(parseFloat(bsa))) return;
            
            // VG indexed values
            const vgDtd = document.getElementById('vg-dtd');
            const vgDtdIndexe = document.getElementById('vg-dtd-indexe');
            if (vgDtd.value && bsa) {
                vgDtdIndexe.value = (parseFloat(vgDtd.value) / parseFloat(bsa)).toFixed(2);
            }
            
            const vgVtd = document.getElementById('vg-vtd');
            const vgVtdIndexe = document.getElementById('vg-vtd-indexe');
            if (vgVtd.value && bsa) {
                vgVtdIndexe.value = (parseFloat(vgVtd.value) / parseFloat(bsa)).toFixed(1);
            }
            
            const vgMasse = document.getElementById('vg-masse');
            const vgMasseIndexee = document.getElementById('vg-masse-indexee');
            if (vgMasse.value && bsa) {
                vgMasseIndexee.value = (parseFloat(vgMasse.value) / parseFloat(bsa)).toFixed(1);
            }
            
            // OG indexed values
            const ogVolume = document.getElementById('og-volume');
            const ogVolumeIndexe = document.getElementById('og-volume-indexe');
            if (ogVolume.value && bsa) {
                ogVolumeIndexe.value = (parseFloat(ogVolume.value) / parseFloat(bsa)).toFixed(1);
            }
            
            // OD indexed values
            const odVolume = document.getElementById('od-volume');
            const odVolumeIndexe = document.getElementById('od-volume-indexe');
            if (odVolume.value && bsa) {
                odVolumeIndexe.value = (parseFloat(odVolume.value) / parseFloat(bsa)).toFixed(1);
            }
            
            // Aortic valve indexed values
            const aoSurface = document.getElementById('ao-surface');
            const aoSurfaceIndexee = document.getElementById('ao-surface-indexee');
            if (aoSurface.value && bsa) {
                aoSurfaceIndexee.value = (parseFloat(aoSurface.value) / parseFloat(bsa)).toFixed(2);
            }
        }
        
        // Add listeners for calculating indexed values
        function initIndexCalculations() {
            // VG indexed values
            document.getElementById('vg-dtd').addEventListener('input', function() {
                const bsa = document.getElementById('sc').value;
                if (this.value && bsa) {
                    document.getElementById('vg-dtd-indexe').value = (parseFloat(this.value) / parseFloat(bsa)).toFixed(2);
                }
            });
            
            document.getElementById('vg-vtd').addEventListener('input', function() {
                const bsa = document.getElementById('sc').value;
                if (this.value && bsa) {
                    document.getElementById('vg-vtd-indexe').value = (parseFloat(this.value) / parseFloat(bsa)).toFixed(1);
                }
            });
            
            document.getElementById('vg-masse').addEventListener('input', function() {
                const bsa = document.getElementById('sc').value;
                if (this.value && bsa) {
                    document.getElementById('vg-masse-indexee').value = (parseFloat(this.value) / parseFloat(bsa)).toFixed(1);
                }
            });
            
            // OG indexed values
            document.getElementById('og-volume').addEventListener('input', function() {
                const bsa = document.getElementById('sc').value;
                if (this.value && bsa) {
                    document.getElementById('og-volume-indexe').value = (parseFloat(this.value) / parseFloat(bsa)).toFixed(1);
                }
            });
            
            // OD indexed values
            document.getElementById('od-volume').addEventListener('input', function() {
                const bsa = document.getElementById('sc').value;
                if (this.value && bsa) {
                    document.getElementById('od-volume-indexe').value = (parseFloat(this.value) / parseFloat(bsa)).toFixed(1);
                }
            });
            
            // Aortic valve indexed values
            document.getElementById('ao-surface').addEventListener('input', function() {
                const bsa = document.getElementById('sc').value;
                if (this.value && bsa) {
                    document.getElementById('ao-surface-indexee').value = (parseFloat(this.value) / parseFloat(bsa)).toFixed(2);
                }
            });
            
            // SIV/PP calculation
            document.getElementById('vg-siv').addEventListener('input', calculateSIVPP);
            document.getElementById('vg-pp').addEventListener('input', calculateSIVPP);
        }
        
        function calculateSIVPP() {
            const siv = parseFloat(document.getElementById('vg-siv').value);
            const pp = parseFloat(document.getElementById('vg-pp').value);
            
            if (siv && pp && !isNaN(siv) && !isNaN(pp)) {
                document.getElementById('vg-sivpp').value = (siv / pp).toFixed(2);
            }
        }
        
        // Valvular diagnostic evaluation
        function initValvularDiagnostic() {
            const updateDiagnosticBtn = document.getElementById('update-valvular-diagnostic');
            const diagnosticContent = document.getElementById('valvular-diagnostic-content');
            
            updateDiagnosticBtn.addEventListener('click', () => {
                evaluateValvularDiagnostic();
            });
            
            function evaluateValvularDiagnostic() {
                let diagnostics = [];
                
                // Aortic valve analysis
                const aoStenosis = document.getElementById('valve-ao-stenose').value;
                const aoInsufficiency = document.getElementById('valve-ao-insuffisance').value;
                const aoVmax = parseFloat(document.getElementById('ao-vmax').value) || 0;
                const aoGradientMean = parseFloat(document.getElementById('ao-gradient-moyen').value) || 0;
                const aoSurface = parseFloat(document.getElementById('ao-surface').value) || 0;
                const aoSurfaceIndexed = parseFloat(document.getElementById('ao-surface-indexee').value) || 0;
                const aoORE = parseFloat(document.getElementById('ao-ore').value) || 0;
                const aoVolReg = parseFloat(document.getElementById('ao-vol-reg').value) || 0;
                
                // Aortic stenosis analysis
                if (aoVmax > 4 || aoGradientMean > 40 || (aoSurface > 0 && aoSurface < 1) || (aoSurfaceIndexed > 0 && aoSurfaceIndexed < 0.6)) {
                    diagnostics.push("Sténose aortique sévère");
                } else if (aoVmax >= 3 && aoVmax <= 4 || aoGradientMean >= 20 && aoGradientMean <= 40 || (aoSurface >= 1 && aoSurface <= 1.5)) {
                    diagnostics.push("Sténose aortique modérée");
                } else if (aoVmax > 2.5 && aoVmax < 3 || aoGradientMean > 10 && aoGradientMean < 20 || (aoSurface > 1.5 && aoSurface < 2)) {
                    diagnostics.push("Sténose aortique légère");
                }
                
                // Aortic regurgitation analysis
                if (aoORE > 30 || aoVolReg > 60) {
                    diagnostics.push("Insuffisance aortique sévère");
                } else if (aoORE >= 20 && aoORE <= 30 || aoVolReg >= 45 && aoVolReg <= 60) {
                    diagnostics.push("Insuffisance aortique modérée");
                } else if (aoORE >= 10 && aoORE < 20 || aoVolReg >= 30 && aoVolReg < 45) {
                    diagnostics.push("Insuffisance aortique légère");
                }
                
                // Mitral valve analysis
                const mitStenosis = document.getElementById('valve-mit-stenose').value;
                const mitInsufficiency = document.getElementById('valve-mit-insuffisance').value;
                const mitSurface = parseFloat(document.getElementById('mit-surface').value) || 0;
                const mitGradientMean = parseFloat(document.getElementById('mit-gradient-moyen').value) || 0;
                const mitPHT = parseFloat(document.getElementById('mit-pht').value) || 0;
                const mitORE = parseFloat(document.getElementById('mit-ore').value) || 0;
                const mitVolReg = parseFloat(document.getElementById('mit-vol-reg').value) || 0;
                const mitVenaContracta = parseFloat(document.getElementById('mit-vena-contracta').value) || 0;
                
                // Mitral stenosis analysis
                if (mitSurface > 0 && mitSurface < 1 || mitGradientMean > 10 || (mitPHT > 0 && mitPHT > 220)) {
                    diagnostics.push("Sténose mitrale sévère");
                } else if (mitSurface >= 1 && mitSurface < 1.5 || mitGradientMean >= 5 && mitGradientMean <= 10 || (mitPHT >= 160 && mitPHT <= 220)) {
                    diagnostics.push("Sténose mitrale modérée");
                } else if (mitSurface >= 1.5 && mitSurface < 2 || mitGradientMean > 0 && mitGradientMean < 5 || (mitPHT > 0 && mitPHT < 160)) {
                    diagnostics.push("Sténose mitrale légère");
                }
                
                // Mitral regurgitation analysis
                if (mitORE > 40 || mitVolReg > 60 || mitVenaContracta > 7) {
                    diagnostics.push("Insuffisance mitrale sévère");
                } else if (mitORE >= 20 && mitORE <= 40 || mitVolReg >= 30 && mitVolReg <= 60 || mitVenaContracta >= 3 && mitVenaContracta <= 7) {
                    diagnostics.push("Insuffisance mitrale modérée");
                } else if (mitORE > 0 && mitORE < 20 || mitVolReg > 0 && mitVolReg < 30 || mitVenaContracta > 0 && mitVenaContracta < 3) {
                    diagnostics.push("Insuffisance mitrale légère");
                }
                
                // Tricuspid valve analysis
                const triInsufficiency = document.getElementById('valve-tri-insuffisance').value;
                const triVenaContracta = parseFloat(document.getElementById('tri-vena-contracta').value) || 0;
                const triORE = parseFloat(document.getElementById('tri-ore').value) || 0;
                const triITVmax = parseFloat(document.getElementById('tri-it-vmax').value) || 0;
                const paps = parseFloat(document.getElementById('doppler-paps').value) || 0;
                
                // Tricuspid regurgitation analysis
                if (triVenaContracta > 7 || triORE > 40) {
                    diagnostics.push("Insuffisance tricuspidienne sévère");
                } else if (triVenaContracta >= 5 && triVenaContracta <= 7 || triORE >= 20 && triORE <= 40) {
                    diagnostics.push("Insuffisance tricuspidienne modérée");
                } else if (triVenaContracta > 0 && triVenaContracta < 5 || triORE > 0 && triORE < 20) {
                    diagnostics.push("Insuffisance tricuspidienne légère");
                }
                
                // Pulmonary hypertension assessment
                if (triITVmax > 3.4 || paps > 50) {
                    diagnostics.push("Hypertension pulmonaire sévère");
                } else if (triITVmax >= 2.9 && triITVmax <= 3.4 || paps >= 35 && paps <= 50) {
                    diagnostics.push("Hypertension pulmonaire modérée");
                } else if (triITVmax > 2.5 && triITVmax < 2.9 || paps > 25 && paps < 35) {
                    diagnostics.push("Hypertension pulmonaire légère");
                }
                
                // Pulmonary valve analysis
                const pulStenosis = document.getElementById('valve-pul-stenose').value;
                const pulInsufficiency = document.getElementById('valve-pul-insuffisance').value;
                const pulVmax = parseFloat(document.getElementById('pul-vmax').value) || 0;
                const pulGradientMean = parseFloat(document.getElementById('pul-gradient-moyen').value) || 0;
                
                // Pulmonary stenosis analysis
                if (pulVmax > 4 || pulGradientMean > 40) {
                    diagnostics.push("Sténose pulmonaire sévère");
                } else if (pulVmax >= 3 && pulVmax <= 4 || pulGradientMean >= 20 && pulGradientMean <= 40) {
                    diagnostics.push("Sténose pulmonaire modérée");
                } else if (pulVmax > 2.2 && pulVmax < 3 || pulGradientMean > 10 && pulGradientMean < 20) {
                    diagnostics.push("Sténose pulmonaire légère");
                }
                
                // Generate the diagnostic text
                if (diagnostics.length > 0) {
                    diagnosticContent.innerHTML = `<ul class="list-disc pl-5">
                        ${diagnostics.map(d => `<li>${d}</li>`).join('')}
                    </ul>`;
                } else {
                    diagnosticContent.innerHTML = "Aucune valvulopathie significative n'a été détectée selon les paramètres renseignés.";
                }
            }
        }
        
        // Cardiomyopathy management
        function initCardiomyopathyManagement() {
            const cardioType = document.getElementById('cardio-type');
            const cmdSection = document.getElementById('cmd-section');
            const cmhSection = document.getElementById('cmh-section');
            const cmrSection = document.getElementById('cmr-section');
            const cmavdSection = document.getElementById('cmavd-section');
            const cmncSection = document.getElementById('cmnc-section');
            const cmtakoSection = document.getElementById('cmtako-section');
            
            const updateBtn = document.getElementById('update-cardiomyopathy-diagnostic');
            const diagnosticContent = document.getElementById('cardiomyopathy-diagnostic-content');
            
            cardioType.addEventListener('change', () => {
                // Hide all sections first
                cmdSection.classList.add('hidden');
                cmhSection.classList.add('hidden');
                cmrSection.classList.add('hidden');
                cmavdSection.classList.add('hidden');
                cmncSection.classList.add('hidden');
                cmtakoSection.classList.add('hidden');
                
                // Show the relevant section based on selection
                switch(cardioType.value) {
                    case 'Dilatée':
                        cmdSection.classList.remove('hidden');
                        break;
                    case 'Hypertrophique':
                        cmhSection.classList.remove('hidden');
                        break;
                    case 'Restrictive':
                        cmrSection.classList.remove('hidden');
                        break;
                    case 'Arythmogène du VD':
                        cmavdSection.classList.remove('hidden');
                        break;
                    case 'Non compaction':
                        cmncSection.classList.remove('hidden');
                        break;
                    case 'Takotsubo':
                        cmtakoSection.classList.remove('hidden');
                        break;
                }
            });
            
            updateBtn.addEventListener('click', () => {
                evaluateCardiomyopathyDiagnostic();
            });
            
            function evaluateCardiomyopathyDiagnostic() {
                const cardioType = document.getElementById('cardio-type').value;
                const cardioSeverite = document.getElementById('cardio-severite').value;
                let diagnosisText = "";
                
                if (cardioType === "Aucune") {
                    diagnosticContent.innerHTML = "Aucune cardiomyopathie n'a été détectée selon les paramètres renseignés.";
                    return;
                }
                
                switch(cardioType) {
                    case 'Dilatée':
                        const cmdDilatation = document.getElementById('cmd-dilatation').value;
                        const cmdSystolique = document.getElementById('cmd-systolique').value;
                        const cmdVd = document.getElementById('cmd-vd').value;
                        const cmdOrigine = document.getElementById('cmd-origine').value;
                        
                        diagnosisText = `Cardiomyopathie dilatée ${cardioSeverite ? cardioSeverite.toLowerCase() : ''} `;
                        
                        if (cmdOrigine !== "Indéterminée") {
                            diagnosisText += `d'origine ${cmdOrigine.toLowerCase()} `;
                        }
                        
                        diagnosisText += `avec dilatation ${cmdDilatation.toLowerCase()} du VG, `;
                        diagnosisText += `dysfonction systolique ${cmdSystolique.toLowerCase()}, `;
                        diagnosisText += `fonction VD ${cmdVd.toLowerCase()}.`;
                        break;
                        
                    case 'Hypertrophique':
                        const cmhType = document.getElementById('cmh-type').value;
                        const cmhEpaisseur = document.getElementById('cmh-epaisseur').value;
                        const cmhObstruction = document.getElementById('cmh-obstruction').value;
                        const cmhGradient = document.getElementById('cmh-gradient').value;
                        const cmhSam = document.getElementById('cmh-sam').value;
                        
                        diagnosisText = `Cardiomyopathie hypertrophique ${cardioSeverite ? cardioSeverite.toLowerCase() : ''} `;
                        diagnosisText += `de type ${cmhType.toLowerCase()}`;
                        
                        if (cmhEpaisseur) {
                            diagnosisText += ` avec épaisseur maximale de ${cmhEpaisseur} mm`;
                        }
                        
                        if (cmhObstruction !== "Absente") {
                            diagnosisText += `, obstruction sous-aortique ${cmhObstruction.toLowerCase()}`;
                            if (cmhGradient) {
                                diagnosisText += ` (gradient ${cmhGradient} mmHg)`;
                            }
                        }
                        
                        if (cmhSam !== "Absent") {
                            diagnosisText += `, SAM ${cmhSam.toLowerCase()}`;
                        }
                        
                        diagnosisText += ".";
                        break;
                        
                    case 'Restrictive':
                        const cmrRemplissage = document.getElementById('cmr-remplissage').value;
                        const cmrDilatation = document.getElementById('cmr-dilatation').value;
                        const cmrParois = document.getElementById('cmr-parois').value;
                        const cmrEtiologie = document.getElementById('cmr-etiologie').value;
                        
                        diagnosisText = `Cardiomyopathie restrictive ${cardioSeverite ? cardioSeverite.toLowerCase() : ''} `;
                        
                        if (cmrEtiologie !== "Indéterminée") {
                            diagnosisText += `de type ${cmrEtiologie.toLowerCase()} `;
                        }
                        
                        diagnosisText += `avec profil de remplissage ${cmrRemplissage.toLowerCase()}`;
                        
                        if (cmrDilatation !== "Absente") {
                            diagnosisText += `, dilatation bi-auriculaire ${cmrDilatation.toLowerCase()}`;
                        }
                        
                        if (cmrParois !== "Absent") {
                            diagnosisText += `, parois myocardiques avec aspect ${cmrParois.toLowerCase()}`;
                        }
                        
                        diagnosisText += ".";
                        break;
                        
                    case 'Arythmogène du VD':
                        const cmavdDilatation = document.getElementById('cmavd-dilatation').value;
                        const cmavdAnevrisme = document.getElementById('cmavd-anevrisme').value;
                        const cmavdDysfonction = document.getElementById('cmavd-dysfonction').value;
                        const cmavdVg = document.getElementById('cmavd-vg').value;
                        
                        diagnosisText = `Cardiomyopathie arythmogène du VD ${cardioSeverite ? cardioSeverite.toLowerCase() : ''} `;
                        
                        if (cmavdDilatation !== "Absente") {
                            diagnosisText += `avec dilatation ${cmavdDilatation.toLowerCase()} du VD`;
                        }
                        
                        if (cmavdAnevrisme === "Présent") {
                            diagnosisText += `, anévrisme du VD`;
                        }
                        
                        if (cmavdDysfonction !== "Absente") {
                            diagnosisText += `, dysfonction VD ${cmavdDysfonction.toLowerCase()}`;
                        }
                        
                        if (cmavdVg === "Présente") {
                            diagnosisText += `, atteinte VG associée`;
                        }
                        
                        diagnosisText += ".";
                        break;
                        
                    case 'Non compaction':
                        const cmncRatio = document.getElementById('cmnc-ratio').value;
                        const cmncLocalisation = document.getElementById('cmnc-localisation').value;
                        const cmncFonction = document.getElementById('cmnc-fonction').value;
                        const cmncThrombus = document.getElementById('cmnc-thrombus').value;
                        
                        diagnosisText = `Cardiomyopathie par non-compaction ${cardioSeverite ? cardioSeverite.toLowerCase() : ''} `;
                        
                        if (cmncRatio) {
                            diagnosisText += `avec ratio NC/C de ${cmncRatio}`;
                        }
                        
                        diagnosisText += `, prédominant au niveau ${cmncLocalisation.toLowerCase()}`;
                        
                        if (cmncFonction !== "Normale") {
                            diagnosisText += `, fonction systolique VG ${cmncFonction.toLowerCase()}`;
                        }
                        
                        if (cmncThrombus === "Présent") {
                            diagnosisText += `, avec thrombus intra-cavitaire`;
                        }
                        
                        diagnosisText += ".";
                        break;
                        
                    case 'Takotsubo':
                        const cmtakoType = document.getElementById('cmtako-type').value;
                        const cmtakoFevg = document.getElementById('cmtako-fevg').value;
                        const cmtakoObstruction = document.getElementById('cmtako-obstruction').value;
                        const cmtakoIm = document.getElementById('cmtako-im').value;
                        
                        diagnosisText = `Cardiomyopathie de Takotsubo `;
                        diagnosisText += `de forme ${cmtakoType.toLowerCase()}`;
                        
                        if (cmtakoFevg) {
                            diagnosisText += ` avec FEVG de ${cmtakoFevg}%`;
                        }
                        
                        if (cmtakoObstruction === "Présente") {
                            diagnosisText += `, obstruction intraventriculaire`;
                        }
                        
                        if (cmtakoIm !== "Absente") {
                            diagnosisText += `, insuffisance mitrale ${cmtakoIm.toLowerCase()} associée`;
                        }
                        
                        diagnosisText += ".";
                        break;
                        
                    case 'Autre':
                        diagnosisText = `Cardiomyopathie de type autre ${cardioSeverite ? '(' + cardioSeverite.toLowerCase() + ')' : ''}.`;
                        break;
                }
                
                diagnosticContent.innerHTML = diagnosisText;
            }
        }
        
        // Congenital Heart Disease management
        function initCongenitalManagement() {
            const updateBtn = document.getElementById('update-congenital-diagnostic');
            const diagnosticContent = document.getElementById('congenital-diagnostic-content');
            
            updateBtn.addEventListener('click', () => {
                evaluateCongenitalDiagnostic();
            });
            
            function evaluateCongenitalDiagnostic() {
                const cia = document.getElementById('cc-cia').value;
                const ciaTaille = document.getElementById('cc-cia-taille').value;
                const civ = document.getElementById('cc-civ').value;
                const civTaille = document.getElementById('cc-civ-taille').value;
                const civGradient = document.getElementById('cc-civ-gradient').value;
                const shuntDirection = document.getElementById('cc-shunt-direction').value;
                const pca = document.getElementById('cc-pca').value;
                const pcaTaille = document.getElementById('cc-pca-taille').value;
                
                const bicuspidie = document.getElementById('cc-bicuspidie').value;
                const fusion = document.getElementById('cc-fusion').value;
                const stenosePulm = document.getElementById('cc-stenose-pulm').value;
                const gradientPulm = document.getElementById('cc-gradient-pulm').value;
                
                const ebstein = document.getElementById('cc-ebstein').value;
                const ebsteinDeplacement = document.getElementById('cc-ebstein-deplacement').value;
                const fallot = document.getElementById('cc-fallot').value;
                const tgv = document.getElementById('cc-tgv').value;
                const autre = document.getElementById('cc-autre').value;
                
                // Build diagnosis
                let diagnoses = [];
                
                // Check for shunts
                if (cia !== "Absente") {
                    let ciaText = `Communication interauriculaire de type ${cia.toLowerCase()}`;
                    if (ciaTaille) {
                        ciaText += ` de ${ciaTaille} mm`;
                    }
                    if (shuntDirection !== "Aucun") {
                        ciaText += ` avec shunt ${shuntDirection.toLowerCase()}`;
                    }
                    diagnoses.push(ciaText);
                }
                
                if (civ !== "Absente") {
                    let civText = `Communication interventriculaire ${civ.toLowerCase()}`;
                    if (civTaille) {
                        civText += ` de ${civTaille} mm`;
                    }
                    if (civGradient) {
                        civText += ` avec gradient de ${civGradient} mmHg`;
                    }
                    if (shuntDirection !== "Aucun") {
                        civText += ` et shunt ${shuntDirection.toLowerCase()}`;
                    }
                    diagnoses.push(civText);
                }
                
                if (pca === "Présent") {
                    let pcaText = "Canal artériel persistant";
                    if (pcaTaille) {
                        pcaText += ` de ${pcaTaille} mm`;
                    }
                    if (shuntDirection !== "Aucun") {
                        pcaText += ` avec shunt ${shuntDirection.toLowerCase()}`;
                    }
                    diagnoses.push(pcaText);
                }
                
                // Check for valve abnormalities
                if (bicuspidie !== "Absente") {
                    let bicuspText = `Bicuspidie aortique ${bicuspidie.toLowerCase()}`;
                    if (fusion !== "Aucune") {
                        bicuspText += ` avec fusion ${fusion.toLowerCase()}`;
                    }
                    diagnoses.push(bicuspText);
                }
                
                if (stenosePulm !== "Absente") {
                    let stenoseText = `Sténose pulmonaire ${stenosePulm.toLowerCase()}`;
                    if (gradientPulm) {
                        stenoseText += ` avec gradient de ${gradientPulm} mmHg`;
                    }
                    diagnoses.push(stenoseText);
                }
                
                // Check for complex congenital heart diseases
                if (ebstein !== "Absente") {
                    let ebsteinText = `Anomalie d'Ebstein ${ebstein.toLowerCase()}`;
                    if (ebsteinDeplacement) {
                        ebsteinText += ` avec décalage septal de ${ebsteinDeplacement} mm`;
                    }
                    diagnoses.push(ebsteinText);
                }
                
                if (fallot !== "Absente") {
                    diagnoses.push(`Tétralogie de Fallot ${fallot.toLowerCase()}`);
                }
                
                if (tgv !== "Absente") {
                    diagnoses.push(`Transposition des gros vaisseaux de type ${tgv.toLowerCase()}`);
                }
                
                if (autre) {
                    diagnoses.push(autre);
                }
                
                if (diagnoses.length > 0) {
                    diagnosticContent.innerHTML = `<ul class="list-disc pl-5">
                        ${diagnoses.map(d => `<li>${d}</li>`).join('')}
                    </ul>`;
                } else {
                    diagnosticContent.innerHTML = "Aucune cardiopathie congénitale n'a été détectée selon les paramètres renseignés.";
                }
            }
        }
        
        // Auto-generate conclusion
        function initConclusionGenerator() {
            const generateBtn = document.getElementById('generate-conclusion');
            
            generateBtn.addEventListener('click', () => {
                generateConclusion();
            });
            
            function generateConclusion() {
                // Get key parameters
                const conclusion = document.getElementById('conclusion');
                
                // VG measurements
                const vgDtd = parseFloat(document.getElementById('vg-dtd').value) || 0;
                const vgFe = parseFloat(document.getElementById('vg-fe').value) || 0;
                const vgFeSimpson = parseFloat(document.getElementById('vg-fe-simpson').value) || 0;
                const fevg = vgFeSimpson || vgFe;
                const vgSiv = parseFloat(document.getElementById('vg-siv').value) || 0;
                const vgPp = parseFloat(document.getElementById('vg-pp').value) || 0;
                
                // Cinétique info
                const cinetiqueType = document.getElementById('cinetique-type').value;
                const cinetiqueEtendue = document.getElementById('cinetique-etendue').value;
                
                // Get regions with troubles
                const regions = [];
                const regionCheckboxes = ['anteroseptale', 'anterieure', 'laterale', 'posterieure', 'inferieure', 'septale', 'apicale', 'basale'];
                regionCheckboxes.forEach(region => {
                    const checkbox = document.getElementById(`cinetique-${region}`);
                    if (checkbox && checkbox.checked) {
                        regions.push(region);
                    }
                });
                
                // Oreillettes
                const ogDiam = parseFloat(document.getElementById('og-transversal').value) || 0;
                const ogSurface = parseFloat(document.getElementById('og-surface').value) || 0;
                const odSurface = parseFloat(document.getElementById('od-surface').value) || 0;
                
                // VD
                const vdTapse = parseFloat(document.getElementById('vd-tapse').value) || 0;
                
                // Doppler
                const dopplerEEprime = parseFloat(document.getElementById('doppler-eeprime').value) || 0;
                const dopplerEA = parseFloat(document.getElementById('doppler-ea').value) || 0;
                const paps = parseFloat(document.getElementById('doppler-paps').value) || 0;
                
                // Valves
                const valveAoStenose = document.getElementById('valve-ao-stenose').value;
                const valveAoInsuff = document.getElementById('valve-ao-insuffisance').value;
                const valveMitStenose = document.getElementById('valve-mit-stenose').value;
                const valveMitInsuff = document.getElementById('valve-mit-insuffisance').value;
                const valveTriInsuff = document.getElementById('valve-tri-insuffisance').value;
                
                // Cardiomyopathies
                const cardioType = document.getElementById('cardio-type').value;
                
                // Congenital
                const cia = document.getElementById('cc-cia').value;
                const civ = document.getElementById('cc-civ').value;
                
                // VCI et péricarde
                const vciDiam = parseFloat(document.getElementById('vci-diametre').value) || 0;
                const vciCompliance = document.getElementById('vci-compliance').value;
                const pericarde = document.getElementById('pericarde').value;
                
                // Generate the conclusion
                let conclusionText = "";
                
                // Assess VG function and size
                if (vgDtd > 55) {
                    conclusionText += "Dilatation des cavités cardiaques gauches";
                    
                    if (vgDtd > 65) {
                        conclusionText += " sévère";
                    } else if (vgDtd > 60) {
                        conclusionText += " modérée";
                    } else {
                        conclusionText += " légère";
                    }
                    
                    if (fevg < 40) {
                        conclusionText += " avec altération sévère de la fonction systolique du VG (FEVG " + fevg + "%)";
                    } else if (fevg < 50) {
                        conclusionText += " avec altération modérée de la fonction systolique du VG (FEVG " + fevg + "%)";
                    } else if (fevg < 55) {
                        conclusionText += " avec altération légère de la fonction systolique du VG (FEVG " + fevg + "%)";
                    } else {
                        conclusionText += " avec fonction systolique du VG conservée (FEVG " + fevg + "%)";
                    }
                    
                    conclusionText += ". ";
                } else if (fevg < 40) {
                    conclusionText += "Altération sévère de la fonction systolique du VG (FEVG " + fevg + "%) sans dilatation. ";
                } else if (fevg < 50) {
                    conclusionText += "Altération modérée de la fonction systolique du VG (FEVG " + fevg + "%) sans dilatation. ";
                } else if (fevg < 55) {
                    conclusionText += "Altération légère de la fonction systolique du VG (FEVG " + fevg + "%) sans dilatation. ";
                } else {
                    conclusionText += "Cavités cardiaques gauches de taille normale avec fonction systolique du VG conservée (FEVG " + fevg + "%). ";
                }
                
                // Add kinetics troubles
                if (cinetiqueType !== "Aucun") {
                    conclusionText += cinetiqueType + " " + (cinetiqueEtendue ? cinetiqueEtendue.toLowerCase() + " " : "");
                    
                    if (regions.length > 0) {
                        conclusionText += "des segments " + regions.join(", ") + ". ";
                    } else {
                        conclusionText += ". ";
                    }
                }
                
                // Assess hypertrophy
                if (vgSiv > 13 || vgPp > 13) {
                    conclusionText += "Hypertrophie ventriculaire gauche";
                    
                    if (vgSiv > 16 || vgPp > 16) {
                        conclusionText += " sévère";
                    } else if (vgSiv > 14 || vgPp > 14) {
                        conclusionText += " modérée";
                    } else {
                        conclusionText += " légère";
                    }
                    
                    if (vgSiv/vgPp > 1.5) {
                        conclusionText += ", asymétrique à prédominance septale";
                    } else if (vgSiv/vgPp < 0.6) {
                        conclusionText += ", asymétrique à prédominance pariétale";
                    } else {
                        conclusionText += ", concentrique";
                    }
                    
                    conclusionText += ". ";
                }
                
                // Add valvulopathies
                let valveAbnormalities = [];
                
                if (valveAoStenose !== "Absente") {
                    valveAbnormalities.push("Sténose aortique " + valveAoStenose.toLowerCase());
                }
                
                if (valveAoInsuff !== "Absente") {
                    valveAbnormalities.push("Insuffisance aortique " + valveAoInsuff.toLowerCase());
                }
                
                if (valveMitStenose !== "Absente") {
                    valveAbnormalities.push("Sténose mitrale " + valveMitStenose.toLowerCase());
                }
                
                if (valveMitInsuff !== "Absente") {
                    valveAbnormalities.push("Insuffisance mitrale " + valveMitInsuff.toLowerCase());
                }
                
                if (valveTriInsuff !== "Absente" && valveTriInsuff !== "Minime") {
                    valveAbnormalities.push("Insuffisance tricuspidienne " + valveTriInsuff.toLowerCase());
                }
                
                if (valveAbnormalities.length > 0) {
                    conclusionText += valveAbnormalities.join(", ") + ". ";
                }
                
                // Add diastolic function assessment
                if (dopplerEEprime > 14) {
                    conclusionText += "Dysfonction diastolique de grade III (profil restrictif). ";
                } else if (dopplerEEprime > 8) {
                    conclusionText += "Dysfonction diastolique de grade II (profil pseudo-normal). ";
                } else if (dopplerEA < 1) {
                    conclusionText += "Dysfonction diastolique de grade I (trouble de la relaxation). ";
                } else if (fevg < 50) {
                    conclusionText += "Fonction diastolique non évaluable (altération de la fonction systolique). ";
                } else {
                    conclusionText += "Fonction diastolique normale. ";
                }
                
                // Add HTAP assessment
                if (paps > 50) {
                    conclusionText += "Hypertension artérielle pulmonaire sévère (PAPs " + paps + " mmHg). ";
                } else if (paps > 35) {
                    conclusionText += "Hypertension artérielle pulmonaire modérée (PAPs " + paps + " mmHg). ";
                } else if (paps > 25) {
                    conclusionText += "Hypertension artérielle pulmonaire légère (PAPs " + paps + " mmHg). ";
                }
                
                // Add VD function
                if (vdTapse < 17) {
                    conclusionText += "Dysfonction ventriculaire droite (TAPSE " + vdTapse + " mm). ";
                }
                
                // Add VCI assessment
                if (vciDiam > 21 && vciCompliance === "Absente") {
                    conclusionText += "VCI dilatée et non compliante, suggestive d'une élévation importante des pressions de remplissage droites. ";
                } else if (vciDiam > 21 && vciCompliance === "Réduite") {
                    conclusionText += "VCI dilatée avec compliance réduite, suggestive d'une élévation modérée des pressions de remplissage droites. ";
                } else if (vciDiam > 21) {
                    conclusionText += "VCI dilatée. ";
                }
                
                // Add pericardial assessment
                if (pericarde !== "Normal") {
                    conclusionText += pericarde + ". ";
                }
                
                // Add cardiomyopathy if present
                if (cardioType !== "Aucune") {
                    let cardioDiag = document.getElementById('cardiomyopathy-diagnostic-content').textContent.trim();
                    if (cardioDiag && cardioDiag !== "Remplissez les critères pour obtenir un diagnostic suggéré.") {
                        conclusionText += cardioDiag + " ";
                    } else {
                        conclusionText += "Cardiomyopathie de type " + cardioType.toLowerCase() + ". ";
                    }
                }
                
                // Add congenital heart disease if present
                if (cia !== "Absente" || civ !== "Absente") {
                    let congenitalDiag = document.getElementById('congenital-diagnostic-content').textContent.trim();
                    if (congenitalDiag && congenitalDiag !== "Remplissez les critères pour obtenir un diagnostic suggéré.") {
                        conclusionText += "Cardiopathie congénitale : " + congenitalDiag + " ";
                    }
                }
                
                // Set the generated conclusion
                conclusion.value = conclusionText.trim();
            }
        }
        
        // Speech Recognition
        function initSpeechRecognition() {
            let recognition;
            let isRecording = false;
            const startButton = document.getElementById('start-recording');
            const stopButton = document.getElementById('stop-recording');
            const recordingIndicator = document.getElementById('recording-indicator');
            const dictationStatus = document.getElementById('dictation-status');
            const commentaireTextarea = document.getElementById('commentaire');
            const dopplerCommentaireTextarea = document.getElementById('doppler-commentaire');
            const conclusionTextarea = document.getElementById('conclusion');
            
            let currentTextarea = commentaireTextarea;
            
            // Check if the browser supports speech recognition
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
                recognition.lang = 'fr-FR';
                recognition.continuous = true;
                recognition.interimResults = true;
                
                recognition.onstart = () => {
                    isRecording = true;
                    startButton.classList.add('hidden');
                    stopButton.classList.remove('hidden');
                    recordingIndicator.classList.remove('hidden');
                    dictationStatus.textContent = "Écoute...";
                };
                
                recognition.onend = () => {
                    isRecording = false;
                    startButton.classList.remove('hidden');
                    stopButton.classList.add('hidden');
                    recordingIndicator.classList.add('hidden');
                    dictationStatus.textContent = "";
                };
                
                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    if (finalTranscript) {
                        currentTextarea.value += finalTranscript + ' ';
                    }
                    
                    dictationStatus.textContent = interimTranscript ? "Écoute: " + interimTranscript : "Écoute...";
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error', event.error);
                    dictationStatus.textContent = "Erreur: " + event.error;
                    
                    // Auto-restart if error
                    if (isRecording) {
                        setTimeout(() => {
                            try {
                                recognition.start();
                            } catch (e) {
                                console.error('Failed to restart recognition', e);
                            }
                        }, 1000);
                    }
                };
                
                startButton.addEventListener('click', () => {
                    try {
                        recognition.start();
                    } catch (e) {
                        console.error('Recognition start error', e);
                    }
                });
                
                stopButton.addEventListener('click', () => {
                    try {
                        recognition.stop();
                    } catch (e) {
                        console.error('Recognition stop error', e);
                    }
                });
                
                // Switch between textareas based on focus
                commentaireTextarea.addEventListener('focus', () => {
                    currentTextarea = commentaireTextarea;
                });
                
                dopplerCommentaireTextarea.addEventListener('focus', () => {
                    currentTextarea = dopplerCommentaireTextarea;
                });
                
                conclusionTextarea.addEventListener('focus', () => {
                    currentTextarea = conclusionTextarea;
                });
                
            } else {
                // Browser doesn't support speech recognition
                startButton.disabled = true;
                startButton.classList.add('opacity-50');
                startButton.title = "Votre navigateur ne supporte pas la reconnaissance vocale";
                dictationStatus.textContent = "Reconnaissance vocale non supportée par ce navigateur";
            }
        }
        
        // Settings Modal
        function initSettingsModal() {
            const settingsBtn = document.getElementById('settingsBtn');
            const settingsModal = document.getElementById('settings-modal');
            const closeSettings = document.getElementById('close-settings');
            const saveSettings = document.getElementById('save-settings');
            
            settingsBtn.addEventListener('click', () => {
                settingsModal.classList.remove('hidden');
            });
            
            closeSettings.addEventListener('click', () => {
                settingsModal.classList.add('hidden');
            });
            
            // Close modal when clicking outside
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    settingsModal.classList.add('hidden');
                }
            });
            
            saveSettings.addEventListener('click', () => {
                // Save settings to local storage
                const settings = {
                    doctorName: document.getElementById('doctor-name').value,
                    organization: document.getElementById('organization').value || 'CNC: Centre National de Cardiologie',
                    logoUrl: document.getElementById('logo-url').value,
                    reportTemplate: document.getElementById('report-template').value
                };
                
                localStorage.setItem('echoCardSettings', JSON.stringify(settings));
                settingsModal.classList.add('hidden');
                
                // Show confirmation message
                showFlashMessage("Paramètres enregistrés avec succès", "success");
                
                // Regenerate report if on report tab
                if (document.getElementById('report').classList.contains('active')) {
                    generateReport();
                }
            });
            
            // Load settings from storage
            const storedSettings = localStorage.getItem('echoCardSettings');
            if (storedSettings) {
                const settings = JSON.parse(storedSettings);
                document.getElementById('doctor-name').value = settings.doctorName || '';
                document.getElementById('organization').value = settings.organization || 'CNC: Centre National de Cardiologie';
                document.getElementById('logo-url').value = settings.logoUrl || '';
                document.getElementById('report-template').value = settings.reportTemplate || 'compact';
            } else {
                // Default settings
                document.getElementById('organization').value = 'CNC: Centre National de Cardiologie';
                document.getElementById('report-template').value = 'compact';
            }
        }
        
        // Report Generation
        function generateReport() {
            const reportPreview = document.getElementById('report-preview');
            const printReportContent = document.getElementById('print-report-content').querySelector('.report-page');
            
            reportPreview.innerHTML = '<div class="text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>Génération du rapport en cours...</p></div>';
            
            setTimeout(() => {
                // Get patient information
                const patientName = document.getElementById('patient-name').value || 'Non spécifié';
                const patientAge = document.getElementById('patient-age').value || '';
                const patientSex = document.getElementById('patient-sex').value || '';
                const patientSexDisplay = patientSex === 'M' ? 'Homme' : (patientSex === 'F' ? 'Femme' : '');
                const patientWeight = document.getElementById('patient-weight').value || '';
                const patientHeight = document.getElementById('patient-height').value || '';
                const patientSC = document.getElementById('sc').value || '';
                const referringDoctor = document.getElementById('referring-doctor').value || 'Non spécifié';
                const examDate = document.getElementById('exam-date').value || new Date().toISOString().split('T')[0];
                const formattedDate = new Date(examDate).toLocaleDateString('fr-FR');
                const clinicalIndication = document.getElementById('clinical-indication').value || 'Non spécifié';
                const echoQuality = document.getElementById('echo-quality').value || 'Bonne';
                
                // Get measurements (only including the most critical ones for a compact report)
                const vgDtd = document.getElementById('vg-dtd').value || '';
                const vgDts = document.getElementById('vg-dts').value || '';
                const vgFe = document.getElementById('vg-fe').value || '';
                const vgFeSimpson = document.getElementById('vg-fe-simpson').value || '';
                const vgSiv = document.getElementById('vg-siv').value || '';
                const vgPp = document.getElementById('vg-pp').value || '';
                const vgSivpp = document.getElementById('vg-sivpp').value || '';
                const ogDiameter = document.getElementById('og-transversal').value || '';
                const ogSurface = document.getElementById('og-surface').value || '';
                const odSurface = document.getElementById('od-surface').value || '';
                const aorteRacine = document.getElementById('aorte-racine').value || '';
                const aorteAscendante = document.getElementById('aorte-ascendante').value || '';
                const vdDtd = document.getElementById('vd-dtd').value || '';
                const vdTapse = document.getElementById('vd-tapse').value || '';
                const vciDiametre = document.getElementById('vci-diametre').value || '';
                const vciCompliance = document.getElementById('vci-compliance').value || '';
                const pericarde = document.getElementById('pericarde').value || '';
                
                // Get cinétique info
                const cinetiqueType = document.getElementById('cinetique-type').value || '';
                const cinetiqueEtendue = document.getElementById('cinetique-etendue').value || '';
                const cinetiqueRegions = [];
                
                const regionCheckboxes = ['anteroseptale', 'anterieure', 'laterale', 'posterieure', 'inferieure', 'septale', 'apicale', 'basale'];
                regionCheckboxes.forEach(region => {
                    const checkbox = document.getElementById(`cinetique-${region}`);
                    if (checkbox && checkbox.checked) {
                        cinetiqueRegions.push(region.charAt(0).toUpperCase() + region.slice(1));
                    }
                });
                
                // Get Doppler information
                const dopplerOndeE = document.getElementById('doppler-onde-e').value || '';
                const dopplerOndeA = document.getElementById('doppler-onde-a').value || '';
                const dopplerEA = document.getElementById('doppler-ea').value || '';
                const dopplerEprime = document.getElementById('doppler-eprime').value || '';
                const dopplerEEprime = document.getElementById('doppler-eeprime').value || '';
                const dopplerItv = document.getElementById('doppler-itv').value || '';
                const dopplerPaps = document.getElementById('doppler-paps').value || '';
                
                // Get valve information
                const valveAortique = document.getElementById('valve-aortique').value || '';
                const valveAoStenose = document.getElementById('valve-ao-stenose').value || '';
                const valveAoInsuff = document.getElementById('valve-ao-insuffisance').value || '';
                const aoVmax = document.getElementById('ao-vmax').value || '';
                const aoGradientMoyen = document.getElementById('ao-gradient-moyen').value || '';
                const aoSurface = document.getElementById('ao-surface').value || '';
                
                const valveMitrale = document.getElementById('valve-mitrale').value || '';
                const valveMitStenose = document.getElementById('valve-mit-stenose').value || '';
                const valveMitInsuff = document.getElementById('valve-mit-insuffisance').value || '';
                const mitSurface = document.getElementById('mit-surface').value || '';
                const mitGradientMoyen = document.getElementById('mit-gradient-moyen').value || '';
                
                const valveTricuspide = document.getElementById('valve-tricuspide').value || '';
                const valveTriInsuff = document.getElementById('valve-tri-insuffisance').value || '';
                
                const valvePulmonaire = document.getElementById('valve-pulmonaire').value || '';
                const valvePulInsuff = document.getElementById('valve-pul-insuffisance').value || '';
                
                // Get cardiomyopathy information
                const cardioType = document.getElementById('cardio-type').value || '';
                let cardioDiagnostic = '';
                if (cardioType !== 'Aucune') {
                    cardioDiagnostic = document.getElementById('cardiomyopathy-diagnostic-content').textContent.trim();
                    if (cardioDiagnostic === 'Remplissez les critères pour obtenir un diagnostic suggéré.') {
                        cardioDiagnostic = '';
                    }
                }
                
                // Get congenital heart disease information
                const cia = document.getElementById('cc-cia').value || '';
                const civ = document.getElementById('cc-civ').value || '';
                let congenitalDiagnostic = '';
                if (cia !== 'Absente' || civ !== 'Absente') {
                    congenitalDiagnostic = document.getElementById('congenital-diagnostic-content').textContent.trim();
                    if (congenitalDiagnostic === 'Remplissez les critères pour obtenir un diagnostic suggéré.') {
                        congenitalDiagnostic = '';
                    }
                }
                
                // Get comments
                const commentaire = document.getElementById('commentaire').value || '';
                const dopplerCommentaire = document.getElementById('doppler-commentaire').value || '';
                const conclusion = document.getElementById('conclusion').value || '';
                
                // Get settings
                let doctorName = 'Médecin Échographiste';
                let organization = 'CNC: Centre National de Cardiologie';
                let logoUrl = '';
                let reportTemplate = 'compact';
                
                const storedSettings = localStorage.getItem('echoCardSettings');
                if (storedSettings) {
                    const settings = JSON.parse(storedSettings);
                    doctorName = settings.doctorName || doctorName;
                    organization = settings.organization || organization;
                    logoUrl = settings.logoUrl || logoUrl;
                    reportTemplate = settings.reportTemplate || reportTemplate;
                }
                
                // Generate report HTML - Compact version
                let reportHtml = `
                    <div class="text-center mb-4">
                        ${logoUrl ? `<img src="${logoUrl}" alt="${organization}" class="h-16 mx-auto mb-2">` : ''}
                        <h1 class="text-xl font-bold">${organization}</h1>
                        <h2 class="text-lg">COMPTE RENDU D'ECHOGRAPHIE DOPPLER CARDIAQUE</h2>
                    </div>
                    
                    <div class="mb-4">
                        <table class="w-full border-collapse text-sm">
                            <tbody>
                                <tr>
                                    <td class="border border-gray-300 px-2 py-1 font-medium w-1/4">Nom et prénom:</td>
                                    <td class="border border-gray-300 px-2 py-1 w-1/4">${patientName}</td>
                                    <td class="border border-gray-300 px-2 py-1 font-medium w-1/4">Date de l'examen:</td>
                                    <td class="border border-gray-300 px-2 py-1 w-1/4">${formattedDate}</td>
                                </tr>
                                <tr>
                                    <td class="border border-gray-300 px-2 py-1 font-medium">Âge:</td>
                                    <td class="border border-gray-300 px-2 py-1">${patientAge}${patientAge ? ' ans' : ''}</td>
                                    <td class="border border-gray-300 px-2 py-1 font-medium">Médecin référent:</td>
                                    <td class="border border-gray-300 px-2 py-1">${referringDoctor}</td>
                                </tr>
                                <tr>
                                    <td class="border border-gray-300 px-2 py-1 font-medium">Sexe:</td>
                                    <td class="border border-gray-300 px-2 py-1">${patientSexDisplay}</td>
                                    <td class="border border-gray-300 px-2 py-1 font-medium">Poids/Taille:</td>
                                    <td class="border border-gray-300 px-2 py-1">${patientWeight ? patientWeight + ' kg' : ''}${patientHeight ? ' / ' + patientHeight + ' cm' : ''}</td>
                                </tr>
                                <tr>
                                    <td class="border border-gray-300 px-2 py-1 font-medium">Motif de l'examen:</td>
                                    <td class="border border-gray-300 px-2 py-1">${clinicalIndication}</td>
                                    <td class="border border-gray-300 px-2 py-1 font-medium">SC:</td>
                                    <td class="border border-gray-300 px-2 py-1">${patientSC ? patientSC + ' m²' : ''}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mb-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h3 class="text-md font-medium mb-2">Mesures principales</h3>
                                <table class="w-full border-collapse text-sm">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-2 py-1">Mesure</th>
                                            <th class="border border-gray-300 px-2 py-1">Résultat</th>
                                            <th class="border border-gray-300 px-2 py-1">Valeur normale</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">VG DTD (mm)</td>
                                            <td class="border border-gray-300 px-2 py-1">${vgDtd}</td>
                                            <td class="border border-gray-300 px-2 py-1 text-xs">37-55</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">VG DTS (mm)</td>
                                            <td class="border border-gray-300 px-2 py-1">${vgDts}</td>
                                            <td class="border border-gray-300 px-2 py-1 text-xs">22-40</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">FE (%)</td>
                                            <td class="border border-gray-300 px-2 py-1">${vgFe || vgFeSimpson}</td>
                                            <td class="border border-gray-300 px-2 py-1 text-xs">53-77</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">SIV (mm)</td>
                                            <td class="border border-gray-300 px-2 py-1">${vgSiv}</td>
                                            <td class="border border-gray-300 px-2 py-1 text-xs">7-11</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">PP (mm)</td>
                                            <td class="border border-gray-300 px-2 py-1">${vgPp}</td>
                                            <td class="border border-gray-300 px-2 py-1 text-xs">7-11</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">SIV/PP</td>
                                            <td class="border border-gray-300 px-2 py-1">${vgSivpp}</td>
                                            <td class="border border-gray-300 px-2 py-1 text-xs">≤ 1.3</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">OG (mm)</td>
                                            <td class="border border-gray-300 px-2 py-1">${ogDiameter}</td>
                                            <td class="border border-gray-300 px-2 py-1 text-xs">19-40</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">Ao racine (mm)</td>
                                            <td class="border border-gray-300 px-2 py-1">${aorteRacine}</td>
                                            <td class="border border-gray-300 px-2 py-1 text-xs">20-37</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div>
                                <h3 class="text-md font-medium mb-2">Doppler & Fonction</h3>
                                <table class="w-full border-collapse text-sm">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-2 py-1">Mesure</th>
                                            <th class="border border-gray-300 px-2 py-1">Résultat</th>
                                            <th class="border border-gray-300 px-2 py-1">Valeur normale</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">E/A</td>
                                            <td class="border border-gray-300 px-2 py-1">${dopplerEA}</td>
                                            <td class="border border-gray-300 px-2 py-1 text-xs">0.7-3.0</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">E/E'</td>
                                            <td class="border border-gray-300 px-2 py-1">${dopplerEEprime}</td>
                                            <td class="border border-gray-300 px-2 py-1 text-xs">≤ 14</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">ITV sous Ao (cm)</td>
                                            <td class="border border-gray-300 px-2 py-1">${dopplerItv}</td>
                                            <td class="border border-gray-300 px-2 py-1 text-xs">18-22</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">VD TAPSE (mm)</td>
                                            <td class="border border-gray-300 px-2 py-1">${vdTapse}</td>
                                            <td class="border border-gray-300 px-2 py-1 text-xs">≥ 17</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">PAPs (mmHg)</td>
                                            <td class="border border-gray-300 px-2 py-1">${dopplerPaps}</td>
                                            <td class="border border-gray-300 px-2 py-1 text-xs">≤ 35</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">VCI (mm)</td>
                                            <td class="border border-gray-300 px-2 py-1 ${vciDiametre ? 'whitespace-nowrap' : ''}">${vciDiametre}${vciDiametre && vciCompliance ? ' / ' + vciCompliance : ''}</td>
                                            <td class="border border-gray-300 px-2 py-1 text-xs">≤ 21 / >50%</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">Péricarde</td>
                                            <td class="border border-gray-300 px-2 py-1" colspan="2">${pericarde}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
                    
                    // Kinetics section
                    if (cinetiqueType && cinetiqueType !== 'Aucun') {
                        reportHtml += `
                        <div class="mb-4">
                            <h3 class="text-md font-medium mb-2">Anomalies de la cinétique</h3>
                            <p class="text-sm">
                                ${cinetiqueType} ${cinetiqueEtendue ? cinetiqueEtendue.toLowerCase() : ''} 
                                ${cinetiqueRegions.length > 0 ? ' des segments ' + cinetiqueRegions.join(', ').toLowerCase() : ''}
                            </p>
                        </div>`;
                    }
                    
                    // Valvular section
                    reportHtml += `
                    <div class="mb-4">
                        <h3 class="text-md font-medium mb-2">Valvulopathies</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <table class="w-full border-collapse text-sm">
                                    <tbody>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-2 py-1" colspan="2">Valve Aortique</th>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1 w-1/3">État</td>
                                            <td class="border border-gray-300 px-2 py-1">${valveAortique}</td>
                                        </tr>
                                        ${valveAoStenose && valveAoStenose !== 'Absente' ? `
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">Sténose</td>
                                            <td class="border border-gray-300 px-2 py-1">${valveAoStenose}</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">Vmax / Gradient</td>
                                            <td class="border border-gray-300 px-2 py-1">${aoVmax ? aoVmax + ' m/s' : ''} ${aoGradientMoyen ? '/ ' + aoGradientMoyen + ' mmHg' : ''}</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">Surface</td>
                                            <td class="border border-gray-300 px-2 py-1">${aoSurface ? aoSurface + ' cm²' : ''}</td>
                                        </tr>` : ''}
                                        ${valveAoInsuff && valveAoInsuff !== 'Absente' ? `
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">Insuffisance</td>
                                            <td class="border border-gray-300 px-2 py-1">${valveAoInsuff}</td>
                                        </tr>` : ''}
                                        
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-2 py-1" colspan="2">Valve Mitrale</th>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">État</td>
                                            <td class="border border-gray-300 px-2 py-1">${valveMitrale}</td>
                                        </tr>
                                        ${valveMitStenose && valveMitStenose !== 'Absente' ? `
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">Sténose</td>
                                            <td class="border border-gray-300 px-2 py-1">${valveMitStenose}</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">Gradient / Surface</td>
                                            <td class="border border-gray-300 px-2 py-1">${mitGradientMoyen ? mitGradientMoyen + ' mmHg' : ''} ${mitSurface ? '/ ' + mitSurface + ' cm²' : ''}</td>
                                        </tr>` : ''}
                                        ${valveMitInsuff && valveMitInsuff !== 'Absente' ? `
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">Insuffisance</td>
                                            <td class="border border-gray-300 px-2 py-1">${valveMitInsuff}</td>
                                        </tr>` : ''}
                                    </tbody>
                                </table>
                            </div>
                            <div>
                                <table class="w-full border-collapse text-sm">
                                    <tbody>
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-2 py-1" colspan="2">Valve Tricuspide</th>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1 w-1/3">État</td>
                                            <td class="border border-gray-300 px-2 py-1">${valveTricuspide}</td>
                                        </tr>
                                        ${valveTriInsuff && valveTriInsuff !== 'Absente' ? `
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">Insuffisance</td>
                                            <td class="border border-gray-300 px-2 py-1">${valveTriInsuff}</td>
                                        </tr>` : ''}
                                        
                                        <tr class="bg-gray-100">
                                            <th class="border border-gray-300 px-2 py-1" colspan="2">Valve Pulmonaire</th>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">État</td>
                                            <td class="border border-gray-300 px-2 py-1">${valvePulmonaire}</td>
                                        </tr>
                                        ${valvePulInsuff && valvePulInsuff !== 'Absente' ? `
                                        <tr>
                                            <td class="border border-gray-300 px-2 py-1">Insuffisance</td>
                                            <td class="border border-gray-300 px-2 py-1">${valvePulInsuff}</td>
                                        </tr>` : ''}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>`;
                
                    // Add cardiomyopathy section if needed
                    if (cardioDiagnostic) {
                        reportHtml += `
                        <div class="mb-4">
                            <h3 class="text-md font-medium mb-2">Cardiomyopathie</h3>
                            <p class="text-sm">${cardioDiagnostic}</p>
                        </div>`;
                    }
                    
                    // Add congenital heart disease section if needed
                    if (congenitalDiagnostic) {
                        reportHtml += `
                        <div class="mb-4">
                            <h3 class="text-md font-medium mb-2">Cardiopathie Congénitale</h3>
                            <div class="text-sm">${congenitalDiagnostic}</div>
                        </div>`;
                    }
                
                    // Only include commentaire if it's not empty
                    if (commentaire.trim()) {
                        reportHtml += `
                        <div class="mb-4">
                            <h3 class="text-md font-medium mb-2">Commentaire :</h3>
                            <div class="whitespace-pre-line text-sm">${commentaire}</div>
                        </div>`;
                    }
                    
                    // Include AI analysis directly in conclusion if available
                    let aiAnalysisContent = '';
                    const aiAnalysisDiv = document.getElementById('ai-analysis');
                    if (!aiAnalysisDiv.classList.contains('hidden')) {
                        const aiContent = document.getElementById('ai-analysis-content').innerHTML;
                        if (aiContent && !aiContent.includes('Analyse en cours')) {
                            aiAnalysisContent = `<div class="mt-2 pt-2 border-t border-gray-200">${aiContent}</div>`;
                        }
                    }
                    
                    reportHtml += `
                    <div class="mb-4">
                        <h3 class="text-md font-medium mb-2">CONCLUSION :</h3>
                        <div class="whitespace-pre-line text-sm">${conclusion || "Pas de conclusion"}</div>
                        ${aiAnalysisContent}
                    </div>
                    
                    <div class="text-right mt-8">
                        <div>${doctorName}</div>
                        <div>Cardiologue - Échographiste</div>
                    </div>`;
                
                // Update both preview and print version
                reportPreview.innerHTML = reportHtml;
                printReportContent.innerHTML = reportHtml;
            }, 500);
        }
        
        // AI Analysis
        function initAIAnalysis() {
            const analyzeReportBtn = document.getElementById('analyze-report');
            const aiAnalysisDiv = document.getElementById('ai-analysis');
            const aiAnalysisContent = document.getElementById('ai-analysis-content');
            
            analyzeReportBtn.addEventListener('click', async () => {
                aiAnalysisDiv.classList.remove('hidden');
                aiAnalysisContent.innerHTML = '<div class="flex items-center"><i class="fas fa-spinner fa-spin mr-2"></i> Analyse en cours...</div>';
                
                try {
                    // Get patient data and measurements for analysis
                    const vgFe = document.getElementById('vg-fe').value || document.getElementById('vg-fe-simpson').value || '';
                    const vgDtd = document.getElementById('vg-dtd').value || '';
                    const vgSiv = document.getElementById('vg-siv').value || '';
                    const vgPp = document.getElementById('vg-pp').value || '';
                    const dopplerEEprime = document.getElementById('doppler-eeprime').value || '';
                    const dopplerEA = document.getElementById('doppler-ea').value || '';
                    const dopplerPaps = document.getElementById('doppler-paps').value || '';
                    const vdTapse = document.getElementById('vd-tapse').value || '';
                    const vciDiametre = document.getElementById('vci-diametre').value || '';
                    const vciCompliance = document.getElementById('vci-compliance').value || '';
                    const pericarde = document.getElementById('pericarde').value || '';
                    
                    // Get valve data
                    const aoGradientMoyen = document.getElementById('ao-gradient-moyen').value || '';
                    const aoSurface = document.getElementById('ao-surface').value || '';
                    const mitGradientMoyen = document.getElementById('mit-gradient-moyen').value || '';
                    const mitSurface = document.getElementById('mit-surface').value || '';
                    
                    // Get cardiomyopathy info
                    const cardioType = document.getElementById('cardio-type').value || '';
                    let cardioDiagnostic = '';
                    if (cardioType !== 'Aucune') {
                        cardioDiagnostic = document.getElementById('cardiomyopathy-diagnostic-content').textContent.trim();
                        if (cardioDiagnostic === 'Remplissez les critères pour obtenir un diagnostic suggéré.') {
                            cardioDiagnostic = '';
                        }
                    }
                    
                    const conclusion = document.getElementById('conclusion').value || '';
                    
                    // Structure the data for Claude
                    const analysisPrompt = `Voici les résultats de l'échographie cardiaque d'un patient:
                        - FE VG: ${vgFe ? vgFe + '%' : 'non renseigné'}
                        - DTD VG: ${vgDtd ? vgDtd + 'mm' : 'non renseigné'}
                        - SIV: ${vgSiv ? vgSiv + 'mm' : 'non renseigné'}
                        - PP: ${vgPp ? vgPp + 'mm' : 'non renseigné'}
                        - E/E': ${dopplerEEprime || 'non renseigné'}
                        - E/A: ${dopplerEA || 'non renseigné'}
                        - PAPs: ${dopplerPaps ? dopplerPaps + 'mmHg' : 'non renseigné'}
                        - TAPSE: ${vdTapse ? vdTapse + 'mm' : 'non renseigné'}
                        - VCI: ${vciDiametre ? vciDiametre + 'mm' : 'non renseigné'}, ${vciCompliance}
                        - Péricarde: ${pericarde}
                        - Gradient aortique moyen: ${aoGradientMoyen ? aoGradientMoyen + 'mmHg' : 'non renseigné'}
                        - Surface aortique: ${aoSurface ? aoSurface + 'cm²' : 'non renseigné'}
                        - Gradient mitral moyen: ${mitGradientMoyen ? mitGradientMoyen + 'mmHg' : 'non renseigné'}
                        - Surface mitrale: ${mitSurface ? mitSurface + 'cm²' : 'non renseigné'}
                        ${cardioDiagnostic ? '- Cardiomyopathie: ' + cardioDiagnostic : ''}
                        - Conclusion du médecin: ${conclusion}
                        
                        Analyse et évalue l'état cardiaque du patient en une phrase concise. Détermine si le patient est critique ou non, et explique pourquoi. S'il manque des informations importantes, mentionne-le. Fournir UNIQUEMENT une réponse concise, professionnelle et médicalement précise. Maximum 2 phrases.`;
                      
                    // Call Claude via Poe API
                    const handlerId = 'echo-analysis-' + Date.now();
                    
                    window.Poe.registerHandler(handlerId, (result) => {
                        const msg = result.responses[0];
                        
                        if (msg.status === "error") {
                            aiAnalysisContent.innerHTML = `<div class="text-red-500"><i class="fas fa-exclamation-circle mr-1"></i> Erreur: ${msg.statusText || "Impossible d'analyser le rapport"}</div>`;
                        } else if (msg.status === "incomplete") {
                            aiAnalysisContent.innerHTML = `<div class="text-blue-500"><i class="fas fa-sync mr-1 fa-spin"></i> Analyse en cours: ${msg.content}</div>`;
                        } else if (msg.status === "complete") {
                            // Format the response
                            if (msg.content.includes("CRITIQUE") || msg.content.includes("critique") || 
                                msg.content.includes("urgent") || msg.content.includes("URGENT") ||
                                msg.content.includes("sévère") || msg.content.includes("grave")) {
                                aiAnalysisContent.innerHTML = `<div class="text-red-600 font-medium"><i class="fas fa-exclamation-triangle mr-1"></i> ${msg.content}</div>`;
                            } else if (msg.content.includes("surveillance") || msg.content.includes("attention") || 
                                      msg.content.includes("modéré") || msg.content.includes("suivi")) {
                                aiAnalysisContent.innerHTML = `<div class="text-amber-600 font-medium"><i class="fas fa-exclamation-circle mr-1"></i> ${msg.content}</div>`;
                            } else {
                                aiAnalysisContent.innerHTML = `<div class="text-green-600 font-medium"><i class="fas fa-check-circle mr-1"></i> ${msg.content}</div>`;
                            }
                            
                            // Update the print version of the report with the AI analysis
                            generateReport();
                        }
                    });

                    try {
                        await window.Poe.sendUserMessage("@Claude-3.7-Sonnet " + analysisPrompt, {
                            handler: handlerId,
                            stream: true,
                            openChat: false
                        });
                    } catch (err) {
                        aiAnalysisContent.innerHTML = `<div class="text-red-500"><i class="fas fa-exclamation-circle mr-1"></i> Erreur: ${err.message || "Impossible de contacter le service d'analyse"}</div>`;
                    }
                    
                } catch (error) {
                    console.error("Error in AI analysis:", error);
                    aiAnalysisContent.innerHTML = `<div class="text-red-500"><i class="fas fa-exclamation-circle mr-1"></i> Erreur: ${error.message || "Une erreur s'est produite lors de l'analyse"}</div>`;
                }
            });
        }
        
        // PDF generation and sharing
        function initExportFunctions() {
            const generatePdfBtn = document.getElementById('generate-pdf');
            const printReportBtn = document.getElementById('print-report');
            const shareReportBtn = document.getElementById('share-report');
            const saveReportBtn = document.getElementById('save-report');
            const resetFormBtn = document.getElementById('reset-form');
            
            // PDF Generation
            generatePdfBtn.addEventListener('click', () => {
                window.print();
            });
            
            // Print
            printReportBtn.addEventListener('click', () => {
                window.print();
            });
            
            // Share
            shareReportBtn.addEventListener('click', () => {
                if (navigator.share) {
                    navigator.share({
                        title: 'Rapport d\'Échographie Cardiaque',
                        text: 'Veuillez trouver ci-joint le rapport d\'échographie cardiaque.',
                        // URL cannot be shared due to iframe restrictions, so just sharing text
                    })
                    .then(() => showFlashMessage("Rapport partagé avec succès", "success"))
                    .catch(error => {
                        console.error('Error sharing', error);
                        showFlashMessage("Erreur lors du partage du rapport", "error");
                    });
                } else {
                    showFlashMessage("Le partage n'est pas pris en charge par votre navigateur. Veuillez utiliser l'option d'impression ou PDF.", "warning");
                }
            });
            
            // Save (to localStorage)
            saveReportBtn.addEventListener('click', () => {
                // Get all form values
                const formData = {
                    patient: {
                        name: document.getElementById('patient-name').value,
                        age: document.getElementById('patient-age').value,
                        sex: document.getElementById('patient-sex').value,
                        weight: document.getElementById('patient-weight').value,
                        height: document.getElementById('patient-height').value,
                        sc: document.getElementById('sc').value,
                        referringDoctor: document.getElementById('referring-doctor').value,
                        examDate: document.getElementById('exam-date').value,
                        clinicalIndication: document.getElementById('clinical-indication').value,
                        echoQuality: document.getElementById('echo-quality').value
                    },
                    cinetique: {
                        type: document.getElementById('cinetique-type').value,
                        etendue: document.getElementById('cinetique-etendue').value,
                        regions: Array.from(document.querySelectorAll('[id^="cinetique-"]:checked')).map(el => el.id.replace('cinetique-', ''))
                    },
                    measurements: {
                        vg: {
                            dtd: document.getElementById('vg-dtd').value,
                            dts: document.getElementById('vg-dts').value,
                            dtdIndexe: document.getElementById('vg-dtd-indexe').value,
                            vtd: document.getElementById('vg-vtd').value,
                            vts: document.getElementById('vg-vts').value,
                            vtdIndexe: document.getElementById('vg-vtd-indexe').value,
                            fr: document.getElementById('vg-fr').value,
                            fe: document.getElementById('vg-fe').value,
                            feSimpson: document.getElementById('vg-fe-simpson').value,
                            siv: document.getElementById('vg-siv').value,
                            pp: document.getElementById('vg-pp').value,
                            sivpp: document.getElementById('vg-sivpp').value,
                            masse: document.getElementById('vg-masse').value,
                            masseIndexee: document.getElementById('vg-masse-indexee').value
                        },
                        og: {
                            ap: document.getElementById('og-ap').value,
                            si: document.getElementById('og-si').value,
                            ml: document.getElementById('og-ml').value,
                            transversal: document.getElementById('og-transversal').value,
                            surface: document.getElementById('og-surface').value,
                            volume: document.getElementById('og-volume').value,
                            volumeIndexe: document.getElementById('og-volume-indexe').value
                        },
                        od: {
                            surface: document.getElementById('od-surface').value,
                            volume: document.getElementById('od-volume').value,
                            volumeIndexe: document.getElementById('od-volume-indexe').value
                        },
                        vd: {
                            dtd: document.getElementById('vd-dtd').value,
                            basal: document.getElementById('vd-basal').value,
                            median: document.getElementById('vd-median').value,
                            longueur: document.getElementById('vd-longueur').value,
                            tapse: document.getElementById('vd-tapse').value,
                            ondeS: document.getElementById('vd-onde-s').value,
                            fac: document.getElementById('vd-fac').value
                        },
                        aorte: {
                            anneau: document.getElementById('aorte-anneau').value,
                            sinus: document.getElementById('aorte-sinus').value,
                            jonction: document.getElementById('aorte-jonction').value,
                            racine: document.getElementById('aorte-racine').value,
                            ascendante: document.getElementById('aorte-ascendante').value,
                            crosse: document.getElementById('aorte-crosse').value,
                            descendante: document.getElementById('aorte-descendante').value
                        },
                        doppler: {
                            ondeE: document.getElementById('doppler-onde-e').value,
                            ondeA: document.getElementById('doppler-onde-a').value,
                            ea: document.getElementById('doppler-ea').value,
                            tde: document.getElementById('doppler-tde').value,
                            eprimeLat: document.getElementById('doppler-eprime-lat').value,
                            eprimeSep: document.getElementById('doppler-eprime-sep').value,
                            eprime: document.getElementById('doppler-eprime').value,
                            eeprime: document.getElementById('doppler-eeprime').value,
                            aprime: document.getElementById('doppler-aprime').value,
                            triv: document.getElementById('doppler-triv').value,
                            itv: document.getElementById('doppler-itv').value,
                            paps: document.getElementById('doppler-paps').value
                        },
                        vci: {
                            diametre: document.getElementById('vci-diametre').value,
                            compliance: document.getElementById('vci-compliance').value
                        },
                        pericarde: document.getElementById('pericarde').value
                    },
                    valves: {
                        aortique: {
                            etat: document.getElementById('valve-aortique').value,
                            stenose: document.getElementById('valve-ao-stenose').value,
                            insuffisance: document.getElementById('valve-ao-insuffisance').value,
                            surface: document.getElementById('ao-surface').value,
                            surfaceIndexee: document.getElementById('ao-surface-indexee').value,
                            vmax: document.getElementById('ao-vmax').value,
                            gradientMoyen: document.getElementById('ao-gradient-moyen').value,
                            gradientMax: document.getElementById('ao-gradient-max').value,
                            ratioVti: document.getElementById('ao-ratio-vti').value,
                            ore: document.getElementById('ao-ore').value,
                            volReg: document.getElementById('ao-vol-reg').value,
                            jetWidth: document.getElementById('ao-jet-width').value
                        },
                        mitrale: {
                            etat: document.getElementById('valve-mitrale').value,
                            stenose: document.getElementById('valve-mit-stenose').value,
                            insuffisance: document.getElementById('valve-mit-insuffisance').value,
                            surface: document.getElementById('mit-surface').value,
                            gradientMoyen: document.getElementById('mit-gradient-moyen').value,
                            pht: document.getElementById('mit-pht').value,
                            ore: document.getElementById('mit-ore').value,
                            volReg: document.getElementById('mit-vol-reg').value,
                            venaContracta: document.getElementById('mit-vena-contracta').value
                        },
                        tricuspide: {
                            etat: document.getElementById('valve-tricuspide').value,
                            stenose: document.getElementById('valve-tri-stenose').value,
                            insuffisance: document.getElementById('valve-tri-insuffisance').value,
                            gradientMoyen: document.getElementById('tri-gradient-moyen').value,
                            venaContracta: document.getElementById('tri-vena-contracta').value,
                            pisa: document.getElementById('tri-pisa').value,
                            ore: document.getElementById('tri-ore').value,
                            itVmax: document.getElementById('tri-it-vmax').value,
                            itGmax: document.getElementById('tri-it-gmax').value
                        },
                        pulmonaire: {
                            etat: document.getElementById('valve-pulmonaire').value,
                            stenose: document.getElementById('valve-pul-stenose').value,
                            insuffisance: document.getElementById('valve-pul-insuffisance').value,
                            vmax: document.getElementById('pul-vmax').value,
                            gradientMoyen: document.getElementById('pul-gradient-moyen').value,
                            gradientMax: document.getElementById('pul-gradient-max').value,
                            ipPhd: document.getElementById('pul-ip-phd').value
                        }
                    },
                    cardiomyopathies: {
                        type: document.getElementById('cardio-type').value,
                        severite: document.getElementById('cardio-severite').value,
                        // Additional fields would be added based on cardiomyopathy type
                    },
                    congenital: {
                        cia: document.getElementById('cc-cia').value,
                        ciaTaille: document.getElementById('cc-cia-taille').value,
                        civ: document.getElementById('cc-civ').value,
                        civTaille: document.getElementById('cc-civ-taille').value,
                        civGradient: document.getElementById('cc-civ-gradient').value,
                        pca: document.getElementById('cc-pca').value,
                        pcaTaille: document.getElementById('cc-pca-taille').value,
                        bicuspidie: document.getElementById('cc-bicuspidie').value,
                        fallot: document.getElementById('cc-fallot').value,
                        tgv: document.getElementById('cc-tgv').value,
                        autre: document.getElementById('cc-autre').value,
                    },
                    commentaires: {
                        general: document.getElementById('commentaire').value,
                        doppler: document.getElementById('doppler-commentaire').value,
                        conclusion: document.getElementById('conclusion').value
                    },
                    timestamp: new Date().toISOString()
                };
                
                // Generate unique ID for this report
                const reportId = 'echoReport_' + Date.now();
                
                // Save to localStorage
                try {
                    localStorage.setItem(reportId, JSON.stringify(formData));
                    
                    // Get existing reports list or create new one
                    let reportsList = JSON.parse(localStorage.getItem('echoReportsList') || '[]');
                    reportsList.push({
                        id: reportId,
                        patientName: formData.patient.name || 'Patient sans nom',
                        date: formData.patient.examDate || new Date().toISOString().split('T')[0],
                        timestamp: formData.timestamp
                    });
                    
                    // Save updated list
                    localStorage.setItem('echoReportsList', JSON.stringify(reportsList));
                    
                    showFlashMessage("Rapport sauvegardé avec succès", "success");
                } catch (error) {
                    console.error('Error saving report', error);
                    showFlashMessage("Erreur lors de la sauvegarde du rapport. L'espace de stockage est peut-être plein.", "error");
                }
            });
            
            // Reset Form
            resetFormBtn.addEventListener('click', () => {
                if (confirm("Êtes-vous sûr de vouloir réinitialiser le formulaire ? Toutes les données non sauvegardées seront perdues.")) {
                    // Reset all form fields
                    document.querySelectorAll('input, textarea, select').forEach(element => {
                        if (element.type === 'date') {
                            element.value = new Date().toISOString().split('T')[0];
                        } else if (element.type === 'checkbox') {
                            element.checked = false;
                        } else {
                            element.value = '';
                        }
                        
                        // Reset selects to first option
                        if (element.tagName === 'SELECT') {
                            element.selectedIndex = 0;
                        }
                    });
                    
                    // Go back to first tab
                    switchToTab('patient-info');
                    
                    showFlashMessage("Formulaire réinitialisé avec succès", "success");
                }
            });
        }
        
        // Flash Messages
        function showFlashMessage(message, type = 'info') {
            const flashMessage = document.getElementById('flash-message');
            flashMessage.textContent = message;
            flashMessage.classList.remove('hidden', 'bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-blue-100', 'text-blue-800', 'bg-yellow-100', 'text-yellow-800');
            
            switch (type) {
                case 'success':
                    flashMessage.classList.add('bg-green-100', 'text-green-800');
                    break;
                case 'error':
                    flashMessage.classList.add('bg-red-100', 'text-red-800');
                    break;
                case 'warning':
                    flashMessage.classList.add('bg-yellow-100', 'text-yellow-800');
                    break;
                default:
                    flashMessage.classList.add('bg-blue-100', 'text-blue-800');
            }
            
            flashMessage.classList.remove('hidden');
            
            setTimeout(() => {
                flashMessage.classList.add('hidden');
            }, 5000);
        }
        
        // Set current date as default
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('exam-date').value = today;
        }
        
        // Initialize the application
        function initApp() {
            initDarkMode();
            initTabs();
            initBSACalculation();
            initIndexCalculations();
            initValvularDiagnostic();
            initCardiomyopathyManagement();
            initCongenitalManagement();
            initConclusionGenerator();
            initSpeechRecognition();
            initSettingsModal();
            initAIAnalysis();
            initExportFunctions();
            setDefaultDate();
            
            // Check for offline support
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/echo-cardio-sw.js').then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }).catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
                });
            }
        }
        
        // Run initialization
        initApp();
    </script>


</body></html>